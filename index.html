<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>나만의 시작 화면</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Minimal white brand favicon (SVG data URI) -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="128" height="128"%3E%3Crect width="128" height="128" rx="28" fill="%23ffffff"/%3E%3Cpath d="M36 40h56v10H36zM36 59h40v10H36zM36 78h56v10H36z" fill="%23111827"/%3E%3C/svg%3E' />

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#ffffff;
      --hover:#f9fafb;
      --chip:#f3f4f6;
      --shadow: 0 10px 30px rgba(17,24,39,.06);
      --radius:16px;
      --max:1100px;

      --warn:#ef4444;
      --gold:#f59e0b;
      --ok:#10b981;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }
    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:34px 18px 56px;
    }

    /* Top */
    .top{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:16px;
      margin-bottom:16px;
    }
    .brand{min-width:0}
    .brand h1{
      font-size:30px;
      letter-spacing:-0.02em;
      margin:0 0 6px 0;
      line-height:1.15;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-size:14px;
    }
    .right{
      display:flex;
      align-items:center;
      gap:10px;
      margin-top:4px;
      flex:0 0 auto;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      color:var(--text);
      white-space:nowrap;
    }
    .btn:hover{background:var(--hover);}
    .btn.primary{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }
    .btn.ghost{
      background:transparent;
    }

    /* Search rows */
    .searchRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:14px;
    }
    .search{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      background:var(--card);
      box-shadow: var(--shadow);
    }
    .search .icon{
      width:36px;height:36px;border-radius:12px;
      background:var(--chip);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-weight:950;
      flex:0 0 auto;
    }
    .search input{
      border:0;
      outline:none;
      width:100%;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.5;
    }

    /* Favorites */
    .favBox{
      margin-top:16px;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .favTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .favTitle{
      font-weight:950;
      letter-spacing:-0.01em;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .pill{
      font-size:12px;
      font-weight:950;
      border:1px solid var(--line);
      background:var(--chip);
      padding:6px 10px;
      border-radius:999px;
      color:var(--text);
      flex:0 0 auto;
    }
    .favHelp{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
    }
    .favGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .favItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:var(--card);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:54px;
    }
    .favItem[draggable="true"]{cursor:grab;}
    .favItem.dragging{opacity:.55;}
    .favItem.dragover{
      outline: 2px dashed rgba(16,185,129,.65);
      outline-offset: 2px;
    }
    .favLeft{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .favLink{
      text-decoration:none;
      color:var(--text);
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
      display:block;
    }
    .favMeta{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .iconBtn{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--chip);
      cursor:pointer;
      font-weight:950;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      flex:0 0 auto;
    }
    .iconBtn:hover{background:var(--hover);}
    .iconBtn.danger{color:var(--warn);}

    /* Categories */
    .cats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:18px 0 12px;
    }
    .chipbtn{
      border:1px solid var(--line);
      background:var(--chip);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:950;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chipbtn:hover{background:var(--hover);}
    .chipbtn.active{
      background:var(--text);
      color:var(--bg);
      border-color:var(--text);
    }
    .count{
      font-size:12px;
      font-weight:950;
      opacity:.75;
    }

    /* Grid cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
      margin-top:12px;
    }

    /* ✅ FIX: no absolute UI, use grid columns */
    .card{
      display:grid;
      grid-template-columns: 1fr auto auto;
      align-items:center;
      gap:10px;
      padding:16px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:var(--card);
      text-decoration:none;
      color:var(--text);
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      min-height:86px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .card:hover{
      background:var(--hover);
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(17,24,39,.08);
    }
    .card[draggable="true"]{cursor:grab;}
    .card.dragging{opacity:.55; transform:none;}
    .card.dragover{
      outline: 2px dashed rgba(16,185,129,.65);
      outline-offset: 2px;
    }

    .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .title{
      font-weight:980;
      letter-spacing:-0.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    /* badge moved into left as a chip line (no overlap) */
    .metaRow{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .badge{
      flex:0 0 auto;
      font-size:12px;
      font-weight:950;
      color:var(--text);
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .star,
    .menu{
      position:static;
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--chip);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:980;
      user-select:none;
      color:var(--muted);
    }
    .star:hover,.menu:hover{background:var(--hover);}
    .star.on{
      color:var(--gold);
      border-color: rgba(245, 158, 11, .35);
    }
    .menu.hidden{display:none;}

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(560px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{font-weight:980; letter-spacing:-0.01em;}
    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .field input, .field select, .field textarea{
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-weight:800;
      font-size:14px;
    }
    .field textarea{
      min-height:140px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      font-weight:700;
      line-height:1.45;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.4;
      margin-top:8px;
    }

    footer{
      margin-top:34px;
      padding-top:18px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      line-height:1.7;
    }

    @media (max-width:820px){
      .searchRow{grid-template-columns:1fr;}
      .row2{grid-template-columns:1fr;}
    }
    @media (max-width:520px){
      .brand h1{font-size:24px;}
      .grid{grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));}
      .favGrid{grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>미니멀 링크 대시보드</h1>
        <p>무회원 · 무수집 · 개인화는 브라우저에만 저장됩니다. (공유는 URL로만 전달)</p>
      </div>

      <div class="right">
        <button class="btn primary" id="addBtn" type="button">내 링크 추가</button>
        <button class="btn" id="resetOrderBtn" type="button">정렬 초기화</button>

        <button class="btn" id="shareBtn" type="button" title="현재 개인화를 URL로 공유">공유 링크</button>
        <button class="btn" id="exportBtn" type="button">내보내기</button>
        <button class="btn" id="importBtn" type="button">가져오기</button>

        <button class="btn" id="installBtn" type="button" style="display:none;">홈화면 설치</button>
        <button class="btn danger" id="wipeBtn" type="button">개인화 초기화</button>

        <button class="btn ghost" type="button" id="resetBtn">초기화</button>
      </div>
    </div>

    <!-- Two search bars -->
    <div class="searchRow">
      <div class="search" title="네이버 검색 (Enter)">
        <div class="icon">N</div>
        <input id="naverQ" placeholder="네이버 검색 (Enter)" autocomplete="off" />
        <button class="btn" type="button" id="naverGo">검색</button>
      </div>

      <div class="search" title="구글 검색 (Enter)">
        <div class="icon">G</div>
        <input id="googleQ" placeholder="구글 검색 (Enter)" autocomplete="off" />
        <button class="btn" type="button" id="googleGo">검색</button>
      </div>
    </div>

    <div class="hint">
      • ⭐: 즐겨찾기(카테고리별 최대 5) • 즐겨찾기/카드 모두 드래그로 순서 저장 • ⋯: 내 링크 편집/삭제 • 공유 링크: 서버 없이 URL로 전달
    </div>

    <!-- Favorites -->
    <div class="favBox">
      <div class="favTop">
        <div class="favTitle">
          <span>즐겨찾기</span>
          <span class="pill" id="favScope">전체</span>
        </div>
        <div class="favHelp">현재 카테고리 기준 저장 (드래그로 순서 변경)</div>
      </div>
      <div class="favGrid" id="favGrid"></div>
    </div>

    <!-- Categories -->
    <div class="cats" id="cats">
      <div class="chipbtn active" data-cat="all">전체 <span class="count" data-count="all">(0)</span></div>
      <div class="chipbtn" data-cat="comm">커뮤니케이션 <span class="count" data-count="comm">(0)</span></div>
      <div class="chipbtn" data-cat="prod">생산성 <span class="count" data-count="prod">(0)</span></div>
      <div class="chipbtn" data-cat="media">미디어 <span class="count" data-count="media">(0)</span></div>
      <div class="chipbtn" data-cat="finance">금융 <span class="count" data-count="finance">(0)</span></div>
      <div class="chipbtn" data-cat="ai">AI <span class="count" data-count="ai">(0)</span></div>
      <div class="chipbtn" data-cat="news">뉴스·리서치 <span class="count" data-count="news">(0)</span></div>
      <div class="chipbtn" data-cat="shop">쇼핑 <span class="count" data-count="shop">(0)</span></div>
      <div class="chipbtn" data-cat="community">커뮤니티 <span class="count" data-count="community">(0)</span></div>
      <div class="chipbtn" data-cat="dev">개발·도구 <span class="count" data-count="dev">(0)</span></div>
      <div class="chipbtn" data-cat="util">유틸리티 <span class="count" data-count="util">(0)</span></div>
    </div>

    <!-- Grid -->
    <div class="grid" id="grid"></div>

    <footer>
      본 사이트는 링크 허브(북마크 대체)입니다. 외부 서비스의 상표/운영 권한은 각 소유자에게 있습니다.<br/>
      회원가입/로그인 없음, 개인정보 수집/저장 없음. 개인화(즐겨찾기/정렬/내 링크)는 브라우저(LocalStorage)에만 저장됩니다.
    </footer>
  </div>

  <!-- Modal: add/edit OR import JSON -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">내 링크 추가</div>
        <button class="iconBtn" id="modalClose" type="button" title="닫기">×</button>
      </div>

      <div class="small" id="modalDesc">현재 선택된 카테고리에 저장됩니다.</div>

      <!-- Link form -->
      <div id="linkFormArea">
        <div class="form">
          <div class="row2">
            <div class="field">
              <label>카테고리</label>
              <select id="fCat">
                <option value="comm">커뮤니케이션</option>
                <option value="prod">생산성</option>
                <option value="media">미디어</option>
                <option value="finance">금융</option>
                <option value="ai">AI</option>
                <option value="news">뉴스·리서치</option>
                <option value="shop">쇼핑</option>
                <option value="community">커뮤니티</option>
                <option value="dev">개발·도구</option>
                <option value="util">유틸리티</option>
              </select>
            </div>
            <div class="field">
              <label>뱃지(표시)</label>
              <input id="fBadge" placeholder="예: ME / PRO / FIN" />
            </div>
          </div>

          <div class="field">
            <label>이름</label>
            <input id="fTitle" placeholder="예: 키워드채팅" />
          </div>

          <div class="field">
            <label>설명</label>
            <input id="fSub" placeholder="예: 내 프로젝트" />
          </div>

          <div class="field">
            <label>URL</label>
            <input id="fHref" placeholder="https://..." />
          </div>
        </div>

        <div class="modalActions">
          <button class="btn danger" id="deleteBtn" type="button" style="display:none;">삭제</button>
          <button class="btn" id="cancelBtn" type="button">취소</button>
          <button class="btn primary" id="saveBtn" type="button">저장</button>
        </div>
      </div>

      <!-- Import area -->
      <div id="importArea" style="display:none;">
        <div class="form">
          <div class="field">
            <label>가져오기 JSON</label>
            <textarea id="importText" placeholder='여기에 JSON을 붙여넣고 "가져오기 적용"을 누르세요.'></textarea>
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="importCancelBtn" type="button">취소</button>
          <button class="btn primary" id="applyImportBtn" type="button">가져오기 적용</button>
        </div>
        <div class="small">주의: 기존 개인화(내 링크/정렬/즐겨찾기)를 덮어씁니다.</div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Keys
    // ---------------------------
    const FAV_KEY = 'xbrand_favorites_v1';
    const ORDER_KEY = 'xbrand_order_v1';
    const CUSTOM_KEY = 'xbrand_custom_links_v1';
    const MAX_FAV = 5;

    // ---------------------------
    // Helpers
    // ---------------------------
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function safeUrl(url){
      try{
        const u = new URL(url);
        if(u.protocol !== 'http:' && u.protocol !== 'https:') return null;
        return u.toString();
      }catch{ return null; }
    }
    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key) || '') ?? fallback; }
      catch{ return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }
    function uid(){
      return 'id_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function chipLabel(cat){
      const map = {
        all:'전체', comm:'커뮤니케이션', prod:'생산성', media:'미디어', finance:'금융', ai:'AI',
        news:'뉴스·리서치', shop:'쇼핑', community:'커뮤니티', dev:'개발·도구', util:'유틸리티'
      };
      return map[cat] || cat;
    }

    // base64url (UTF-8 safe)
    function toBase64Url(str){
      const bytes = new TextEncoder().encode(str);
      let bin = '';
      bytes.forEach(b => bin += String.fromCharCode(b));
      const b64 = btoa(bin);
      return b64.replaceAll('+','-').replaceAll('/','_').replaceAll('=','');
    }
    function fromBase64Url(b64url){
      let b64 = b64url.replaceAll('-','+').replaceAll('_','/');
      while(b64.length % 4) b64 += '=';
      const bin = atob(b64);
      const bytes = new Uint8Array(bin.length);
      for(let i=0;i<bin.length;i++) bytes[i] = bin.charCodeAt(i);
      return new TextDecoder().decode(bytes);
    }

    // ---------------------------
    // Base links (추천)
    // ---------------------------
    const BASE = [
      // comm
      {id:'b_comm_1',cat:'comm',title:'Telegram Web',sub:'메신저',href:'https://web.telegram.org',badge:'COMM'},
      {id:'b_comm_2',cat:'comm',title:'Discord',sub:'커뮤니티/채팅',href:'https://discord.com/app',badge:'COMM'},
      {id:'b_comm_3',cat:'comm',title:'Slack',sub:'업무 메신저',href:'https://slack.com/signin',badge:'COMM'},
      {id:'b_comm_4',cat:'comm',title:'Gmail',sub:'메일',href:'https://mail.google.com',badge:'COMM'},
      {id:'b_comm_5',cat:'comm',title:'Blind',sub:'직장인',href:'https://www.blind.com',badge:'COMM'},
      {id:'b_comm_6',cat:'comm',title:'DCInside',sub:'커뮤니티',href:'https://www.dcinside.com',badge:'COMM'},
      {id:'b_comm_7',cat:'comm',title:'Kakao OpenChat',sub:'오픈채팅',href:'https://open.kakao.com',badge:'COMM'},
      {id:'b_comm_8',cat:'comm',title:'Naver',sub:'포털',href:'https://www.naver.com',badge:'COMM'},
      {id:'b_comm_9',cat:'comm',title:'Google Account',sub:'계정',href:'https://accounts.google.com',badge:'COMM'},
      {id:'b_comm_10',cat:'comm',title:'Messenger',sub:'메신저',href:'https://www.facebook.com/messages',badge:'COMM'},

      // prod
      {id:'b_prod_1',cat:'prod',title:'Notion',sub:'문서 · 위키',href:'https://www.notion.so',badge:'PROD'},
      {id:'b_prod_2',cat:'prod',title:'Google Docs',sub:'문서',href:'https://docs.google.com',badge:'PROD'},
      {id:'b_prod_3',cat:'prod',title:'Google Sheets',sub:'스프레드시트',href:'https://sheets.google.com',badge:'PROD'},
      {id:'b_prod_4',cat:'prod',title:'Google Drive',sub:'파일',href:'https://drive.google.com',badge:'PROD'},
      {id:'b_prod_5',cat:'prod',title:'Google Calendar',sub:'일정',href:'https://calendar.google.com',badge:'PROD'},
      {id:'b_prod_6',cat:'prod',title:'Microsoft Excel',sub:'엑셀',href:'https://www.microsoft.com/microsoft-365/excel',badge:'PROD'},
      {id:'b_prod_7',cat:'prod',title:'Microsoft 365',sub:'오피스',href:'https://www.office.com',badge:'PROD'},
      {id:'b_prod_8',cat:'prod',title:'Figma',sub:'디자인',href:'https://www.figma.com',badge:'PROD'},
      {id:'b_prod_9',cat:'prod',title:'Trello',sub:'칸반',href:'https://trello.com',badge:'PROD'},
      {id:'b_prod_10',cat:'prod',title:'Canva',sub:'템플릿',href:'https://www.canva.com',badge:'PROD'},

      // media
      {id:'b_media_1',cat:'media',title:'YouTube',sub:'동영상',href:'https://www.youtube.com',badge:'MEDIA'},
      {id:'b_media_2',cat:'media',title:'YouTube Music',sub:'음악',href:'https://music.youtube.com',badge:'MEDIA'},
      {id:'b_media_3',cat:'media',title:'Netflix',sub:'스트리밍',href:'https://www.netflix.com',badge:'MEDIA'},
      {id:'b_media_4',cat:'media',title:'Naver Webtoon',sub:'웹툰',href:'https://comic.naver.com',badge:'MEDIA'},
      {id:'b_media_5',cat:'media',title:'Kakao Webtoon',sub:'웹툰',href:'https://webtoon.kakao.com',badge:'MEDIA'},
      {id:'b_media_6',cat:'media',title:'TVING',sub:'국내 OTT',href:'https://www.tving.com',badge:'MEDIA'},
      {id:'b_media_7',cat:'media',title:'Wavve',sub:'국내 OTT',href:'https://www.wavve.com',badge:'MEDIA'},
      {id:'b_media_8',cat:'media',title:'Spotify',sub:'음악',href:'https://www.spotify.com',badge:'MEDIA'},
      {id:'b_media_9',cat:'media',title:'Twitch',sub:'라이브',href:'https://www.twitch.tv',badge:'MEDIA'},
      {id:'b_media_10',cat:'media',title:'Disney+',sub:'스트리밍',href:'https://www.disneyplus.com',badge:'MEDIA'},

      // finance
      {id:'b_fin_1',cat:'finance',title:'Naver Finance',sub:'국내 시세',href:'https://finance.naver.com',badge:'FIN'},
      {id:'b_fin_2',cat:'finance',title:'TradingView',sub:'차트',href:'https://www.tradingview.com',badge:'FIN'},
      {id:'b_fin_3',cat:'finance',title:'Bitget',sub:'거래소',href:'https://www.bitget.com',badge:'FIN'},
      {id:'b_fin_4',cat:'finance',title:'Binance',sub:'거래소',href:'https://www.binance.com',badge:'FIN'},
      {id:'b_fin_5',cat:'finance',title:'CoinMarketCap',sub:'시총',href:'https://www.coinmarketcap.com',badge:'FIN'},
      {id:'b_fin_6',cat:'finance',title:'CoinGecko',sub:'데이터',href:'https://www.coingecko.com',badge:'FIN'},
      {id:'b_fin_7',cat:'finance',title:'Google Finance',sub:'시장',href:'https://www.google.com/finance',badge:'FIN'},
      {id:'b_fin_8',cat:'finance',title:'Investing',sub:'데이터',href:'https://www.investing.com',badge:'FIN'},
      {id:'b_fin_9',cat:'finance',title:'Toss',sub:'금융',href:'https://www.toss.im',badge:'FIN'},
      {id:'b_fin_10',cat:'finance',title:'KakaoBank',sub:'은행',href:'https://www.kakaobank.com',badge:'FIN'},

      // ai
      {id:'b_ai_1',cat:'ai',title:'ChatGPT',sub:'대화형 AI',href:'https://chat.openai.com',badge:'AI'},
      {id:'b_ai_2',cat:'ai',title:'Claude',sub:'대화형 AI',href:'https://claude.ai',badge:'AI'},
      {id:'b_ai_3',cat:'ai',title:'Gemini',sub:'구글 AI',href:'https://gemini.google.com',badge:'AI'},
      {id:'b_ai_4',cat:'ai',title:'Perplexity',sub:'AI 검색',href:'https://www.perplexity.ai',badge:'AI'},
      {id:'b_ai_5',cat:'ai',title:'OpenAI Platform',sub:'API',href:'https://platform.openai.com',badge:'AI'},
      {id:'b_ai_6',cat:'ai',title:'Hugging Face',sub:'모델/데이터',href:'https://huggingface.co',badge:'AI'},
      {id:'b_ai_7',cat:'ai',title:'GitHub Copilot',sub:'코딩',href:'https://copilot.github.com',badge:'AI'},
      {id:'b_ai_8',cat:'ai',title:'Cursor',sub:'AI 에디터',href:'https://www.cursor.com',badge:'AI'},
      {id:'b_ai_9',cat:'ai',title:'Midjourney',sub:'이미지',href:'https://www.midjourney.com',badge:'AI'},
      {id:'b_ai_10',cat:'ai',title:'Recraft',sub:'디자인',href:'https://recraft.ai',badge:'AI'},

      // news
      {id:'b_news_1',cat:'news',title:'Naver News',sub:'뉴스',href:'https://news.naver.com',badge:'NEWS'},
      {id:'b_news_2',cat:'news',title:'Google News',sub:'뉴스',href:'https://news.google.com',badge:'NEWS'},
      {id:'b_news_3',cat:'news',title:'Bloomberg',sub:'금융뉴스',href:'https://www.bloomberg.com',badge:'NEWS'},
      {id:'b_news_4',cat:'news',title:'Reuters',sub:'글로벌',href:'https://www.reuters.com',badge:'NEWS'},
      {id:'b_news_5',cat:'news',title:'Financial Times',sub:'금융',href:'https://www.ft.com',badge:'NEWS'},
      {id:'b_news_6',cat:'news',title:'WSJ',sub:'비즈니스',href:'https://www.wsj.com',badge:'NEWS'},
      {id:'b_news_7',cat:'news',title:'The Economist',sub:'시사',href:'https://www.economist.com',badge:'NEWS'},
      {id:'b_news_8',cat:'news',title:'arXiv',sub:'논문',href:'https://arxiv.org',badge:'NEWS'},
      {id:'b_news_9',cat:'news',title:'The Information',sub:'리서치',href:'https://www.theinformation.com',badge:'NEWS'},
      {id:'b_news_10',cat:'news',title:'NYTimes',sub:'뉴스',href:'https://www.nytimes.com',badge:'NEWS'},

      // shop
      {id:'b_shop_1',cat:'shop',title:'Coupang',sub:'쇼핑',href:'https://www.coupang.com',badge:'SHOP'},
      {id:'b_shop_2',cat:'shop',title:'Naver Shopping',sub:'가격비교',href:'https://shopping.naver.com',badge:'SHOP'},
      {id:'b_shop_3',cat:'shop',title:'11st',sub:'쇼핑',href:'https://www.11st.co.kr',badge:'SHOP'},
      {id:'b_shop_4',cat:'shop',title:'Gmarket',sub:'쇼핑',href:'https://www.gmarket.co.kr',badge:'SHOP'},
      {id:'b_shop_5',cat:'shop',title:'Auction',sub:'쇼핑',href:'https://www.auction.co.kr',badge:'SHOP'},
      {id:'b_shop_6',cat:'shop',title:'SSG',sub:'쇼핑',href:'https://www.ssg.com',badge:'SHOP'},
      {id:'b_shop_7',cat:'shop',title:'오늘의집',sub:'리빙',href:'https://www.todayhouse.com',badge:'SHOP'},
      {id:'b_shop_8',cat:'shop',title:'Amazon',sub:'해외',href:'https://www.amazon.com',badge:'SHOP'},
      {id:'b_shop_9',cat:'shop',title:'AliExpress',sub:'해외',href:'https://www.aliexpress.com',badge:'SHOP'},
      {id:'b_shop_10',cat:'shop',title:'Temu',sub:'해외',href:'https://www.temu.com',badge:'SHOP'},

      // community
      {id:'b_comu_1',cat:'community',title:'FMKOREA',sub:'커뮤니티',href:'https://www.fmkorea.com',badge:'COMM'},
      {id:'b_comu_2',cat:'community',title:'Clien',sub:'커뮤니티',href:'https://www.clien.net',badge:'COMM'},
      {id:'b_comu_3',cat:'community',title:'Ppomppu',sub:'커뮤니티',href:'https://www.ppomppu.co.kr',badge:'COMM'},
      {id:'b_comu_4',cat:'community',title:'Ruliweb',sub:'커뮤니티',href:'https://www.ruliweb.com',badge:'COMM'},
      {id:'b_comu_5',cat:'community',title:'Inven',sub:'게임',href:'https://www.inven.co.kr',badge:'COMM'},
      {id:'b_comu_6',cat:'community',title:'DCInside',sub:'커뮤니티',href:'https://www.dcinside.com',badge:'COMM'},
      {id:'b_comu_7',cat:'community',title:'Blind',sub:'직장인',href:'https://www.blind.com',badge:'COMM'},
      {id:'b_comu_8',cat:'community',title:'Reddit',sub:'글로벌',href:'https://www.reddit.com',badge:'COMM'},
      {id:'b_comu_9',cat:'community',title:'Quora',sub:'Q&A',href:'https://www.quora.com',badge:'COMM'},
      {id:'b_comu_10',cat:'community',title:'키워드채팅',sub:'내 프로젝트 (URL 교체)',href:'https://example.com/keyword-chatting',badge:'ME'},

      // dev
      {id:'b_dev_1',cat:'dev',title:'GitHub',sub:'코드',href:'https://github.com',badge:'DEV'},
      {id:'b_dev_2',cat:'dev',title:'Vercel',sub:'배포',href:'https://vercel.com',badge:'DEV'},
      {id:'b_dev_3',cat:'dev',title:'Netlify',sub:'배포',href:'https://www.netlify.com',badge:'DEV'},
      {id:'b_dev_4',cat:'dev',title:'Google Developers',sub:'문서',href:'https://developers.google.com',badge:'DEV'},
      {id:'b_dev_5',cat:'dev',title:'Stack Overflow',sub:'Q&A',href:'https://stackoverflow.com',badge:'DEV'},
      {id:'b_dev_6',cat:'dev',title:'CodePen',sub:'실험',href:'https://codepen.io',badge:'DEV'},
      {id:'b_dev_7',cat:'dev',title:'Replit',sub:'코딩',href:'https://replit.com',badge:'DEV'},
      {id:'b_dev_8',cat:'dev',title:'Postman',sub:'API',href:'https://www.postman.com',badge:'DEV'},
      {id:'b_dev_9',cat:'dev',title:'Cloudflare',sub:'CDN',href:'https://cloudflare.com',badge:'DEV'},
      {id:'b_dev_10',cat:'dev',title:'Supabase',sub:'DB/Auth',href:'https://supabase.com',badge:'DEV'},

      // util
      {id:'b_util_1',cat:'util',title:'Google Translate',sub:'번역',href:'https://translate.google.com',badge:'UTIL'},
      {id:'b_util_2',cat:'util',title:'Google Keep',sub:'메모',href:'https://keep.google.com',badge:'UTIL'},
      {id:'b_util_3',cat:'util',title:'Google Calendar',sub:'일정',href:'https://calendar.google.com',badge:'UTIL'},
      {id:'b_util_4',cat:'util',title:'Naver Map',sub:'지도',href:'https://map.naver.com',badge:'UTIL'},
      {id:'b_util_5',cat:'util',title:'Kakao Map',sub:'지도',href:'https://map.kakao.com',badge:'UTIL'},
      {id:'b_util_6',cat:'util',title:'Naver Weather',sub:'날씨',href:'https://weather.naver.com',badge:'UTIL'},
      {id:'b_util_7',cat:'util',title:'Speedtest',sub:'속도',href:'https://www.speedtest.net',badge:'UTIL'},
      {id:'b_util_8',cat:'util',title:'Time & Date',sub:'시간',href:'https://www.timeanddate.com',badge:'UTIL'},
      {id:'b_util_9',cat:'util',title:'remove.bg',sub:'배경 제거',href:'https://www.remove.bg',badge:'UTIL'},
      {id:'b_util_10',cat:'util',title:'Google Drive',sub:'드라이브',href:'https://drive.google.com',badge:'UTIL'},
    ];

    // ---------------------------
    // DOM refs
    // ---------------------------
    const resetBtn = document.getElementById('resetBtn');
    const resetOrderBtn = document.getElementById('resetOrderBtn');
    const wipeBtn = document.getElementById('wipeBtn');
    const addBtn = document.getElementById('addBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const shareBtn = document.getElementById('shareBtn');
    const installBtn = document.getElementById('installBtn');

    const naverQ = document.getElementById('naverQ');
    const googleQ = document.getElementById('googleQ');
    const naverGo = document.getElementById('naverGo');
    const googleGo = document.getElementById('googleGo');

    const chips = Array.from(document.querySelectorAll('.chipbtn'));
    const grid = document.getElementById('grid');
    const favGrid = document.getElementById('favGrid');
    const favScope = document.getElementById('favScope');

    // Modal refs
    const modalBack = document.getElementById('modalBack');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalClose = document.getElementById('modalClose');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');

    const linkFormArea = document.getElementById('linkFormArea');
    const importArea = document.getElementById('importArea');
    const importText = document.getElementById('importText');
    const importCancelBtn = document.getElementById('importCancelBtn');
    const applyImportBtn = document.getElementById('applyImportBtn');

    const fCat = document.getElementById('fCat');
    const fBadge = document.getElementById('fBadge');
    const fTitle = document.getElementById('fTitle');
    const fSub = document.getElementById('fSub');
    const fHref = document.getElementById('fHref');

    // ---------------------------
    // State
    // ---------------------------
    let currentCat = 'all';
    let editingId = null;

    // ---------------------------
    // Search
    // ---------------------------
    function openNaver(){
      const q = (naverQ.value || '').trim();
      if(!q) return;
      window.open(`https://search.naver.com/search.naver?query=${encodeURIComponent(q)}`, '_blank', 'noopener');
    }
    function openGoogle(){
      const q = (googleQ.value || '').trim();
      if(!q) return;
      window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank', 'noopener');
    }
    naverGo.addEventListener('click', openNaver);
    googleGo.addEventListener('click', openGoogle);
    naverQ.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') openNaver(); });
    googleQ.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') openGoogle(); });

    // ---------------------------
    // Favorites
    // ---------------------------
    function getFavData(){ return loadJSON(FAV_KEY, {}); }
    function setFavData(data){ saveJSON(FAV_KEY, data); }
    function getFavList(cat){
      const data = getFavData();
      return Array.isArray(data[cat]) ? data[cat] : [];
    }
    function setFavList(cat, list){
      const data = getFavData();
      data[cat] = list;
      setFavData(data);
    }
    function isFav(cat, href){
      return getFavList(cat).some(x => x.href === href);
    }
    function toggleFav(cat, item){
      const list = getFavList(cat);
      const idx = list.findIndex(x => x.href === item.href);

      if(idx >= 0){
        list.splice(idx, 1);
        setFavList(cat, list);
      }else{
        list.unshift(item);
        const seen = new Set();
        const deduped = [];
        for(const x of list){
          if(seen.has(x.href)) continue;
          seen.add(x.href);
          deduped.push(x);
        }
        while(deduped.length > MAX_FAV) deduped.pop();
        setFavList(cat, deduped);
      }
      renderFav();
      syncStars();
    }
    function removeFav(cat, href){
      const list = getFavList(cat).filter(x => x.href !== href);
      setFavList(cat, list);
      renderFav();
      syncStars();
    }
    function persistFavOrderFromDOM(){
      const cat = currentCat;
      const hrefs = Array.from(favGrid.querySelectorAll('.favItem'))
        .map(el => el.dataset.href)
        .filter(Boolean);
      const list = getFavList(cat);
      const map = new Map(list.map(x => [x.href, x]));
      const ordered = [];
      hrefs.forEach(h => { if(map.has(h)) ordered.push(map.get(h)); });
      list.forEach(x => { if(!hrefs.includes(x.href)) ordered.push(x); });
      setFavList(cat, ordered);
    }
    function renderFav(){
      const cat = currentCat;
      const list = getFavList(cat);

      favGrid.innerHTML = '';
      if(list.length === 0){
        favGrid.innerHTML = `
          <div class="favItem" style="grid-column:1/-1; justify-content:flex-start;">
            <div class="favLeft">
              <div class="favLink">비어있음</div>
              <div class="favMeta">아래 카드의 ⭐를 눌러 즐겨찾기를 추가하세요. (카테고리별 최대 ${MAX_FAV}개)</div>
            </div>
          </div>
        `;
        return;
      }

      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'favItem';
        div.setAttribute('draggable','true');
        div.dataset.href = item.href;
        div.innerHTML = `
          <div class="favLeft">
            <a class="favLink" href="${item.href}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
            <div class="favMeta">${escapeHtml(item.sub || '')}</div>
          </div>
          <button class="iconBtn danger" title="삭제">×</button>
        `;
        div.querySelector('.iconBtn').addEventListener('click', () => removeFav(cat, item.href));
        favGrid.appendChild(div);
      });

      enableFavDrag();
    }
    function enableFavDrag(){
      const items = Array.from(favGrid.querySelectorAll('.favItem'));
      let draggingEl = null;

      items.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggingEl = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.href || '');
        });
        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          items.forEach(x => x.classList.remove('dragover'));
          draggingEl = null;
          persistFavOrderFromDOM();
        });
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          if(!draggingEl || draggingEl === el) return;
          el.classList.add('dragover');
        });
        el.addEventListener('dragleave', () => el.classList.remove('dragover'));
        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('dragover');
          if(!draggingEl || draggingEl === el) return;

          const rect = el.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);

          if(after) el.insertAdjacentElement('afterend', draggingEl);
          else el.insertAdjacentElement('beforebegin', draggingEl);
        });
      });
    }

    // ---------------------------
    // Custom links
    // ---------------------------
    function loadCustom(){ return loadJSON(CUSTOM_KEY, []); }
    function saveCustom(arr){ saveJSON(CUSTOM_KEY, arr); }
    function upsertCustom(item){
      const arr = loadCustom();
      const idx = arr.findIndex(x => x.id === item.id);
      if(idx >= 0) arr[idx] = item;
      else arr.unshift(item);
      saveCustom(arr);
    }
    function deleteCustom(id){
      saveCustom(loadCustom().filter(x => x.id !== id));
    }

    // ---------------------------
    // Order per category
    // ---------------------------
    function getOrderData(){ return loadJSON(ORDER_KEY, {}); }
    function setOrderData(data){ saveJSON(ORDER_KEY, data); }
    function getOrder(cat){
      const data = getOrderData();
      return Array.isArray(data[cat]) ? data[cat] : null;
    }
    function setOrder(cat, ids){
      const data = getOrderData();
      data[cat] = ids;
      setOrderData(data);
    }
    function clearOrder(cat){
      const data = getOrderData();
      delete data[cat];
      setOrderData(data);
    }

    // ---------------------------
    // Build items for category
    // ---------------------------
    function getItemsForCat(cat){
      const custom = loadCustom().map(x => ({...x, custom:true}));
      const all = BASE.map(x => ({...x, custom:false})).concat(custom);

      let items = (cat === 'all') ? all : all.filter(x => x.cat === cat);

      const order = getOrder(cat);
      if(order && order.length){
        const map = new Map(items.map(x => [x.id, x]));
        const ordered = [];
        order.forEach(id => { if(map.has(id)) ordered.push(map.get(id)); });
        items.forEach(x => { if(!order.includes(x.id)) ordered.push(x); });
        items = ordered;
      }
      return items;
    }

    // ---------------------------
    // Render grid (✅ fixed layout)
    // ---------------------------
    function renderGrid(){
      const items = getItemsForCat(currentCat);

      grid.innerHTML = items.map(item => {
        const menuHidden = item.custom ? '' : 'hidden';
        const draggable = (currentCat === 'all') ? 'false' : 'true';

        return `
          <a class="card" href="${item.href}" target="_blank" rel="noopener"
             data-id="${item.id}" data-cat="${item.cat}" draggable="${draggable}">
            <div class="left">
              <div class="title">${escapeHtml(item.title)}</div>
              <div class="metaRow">
                <div class="sub">${escapeHtml(item.sub || '')}</div>
                ${item.badge ? `<div class="badge" title="${escapeHtml(item.badge)}">${escapeHtml(item.badge)}</div>` : ``}
              </div>
            </div>

            <div class="star" title="즐겨찾기">☆</div>
            <div class="menu ${menuHidden}" title="내 링크 편집/삭제">⋯</div>
          </a>
        `;
      }).join('');

      attachCardHandlers();
      syncStars();
      updateCounts();
    }

    function attachCardHandlers(){
      const cards = Array.from(grid.querySelectorAll('.card'));

      cards.forEach(card => {
        const star = card.querySelector('.star');
        star.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const item = {
            title: card.querySelector('.title')?.innerText || '즐겨찾기',
            sub: card.querySelector('.sub')?.innerText || '',
            href: card.getAttribute('href')
          };
          toggleFav(currentCat, item);
        });

        const menu = card.querySelector('.menu');
        if(!menu.classList.contains('hidden')){
          menu.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = card.dataset.id;
            const item = loadCustom().find(x => x.id === id);
            if(item) openLinkModal('edit', item);
          });
        }
      });

      if(currentCat !== 'all') enableCardDrag(cards);
    }

    function syncStars(){
      const anchors = Array.from(grid.querySelectorAll('.card'));
      anchors.forEach(card => {
        const star = card.querySelector('.star');
        const href = card.getAttribute('href');
        const on = isFav(currentCat, href);
        star.classList.toggle('on', on);
        star.textContent = on ? '★' : '☆';
      });
    }

    function enableCardDrag(cards){
      let draggingEl = null;

      cards.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggingEl = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.id);
        });

        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          cards.forEach(x => x.classList.remove('dragover'));
          draggingEl = null;
          persistOrderFromDOM();
        });

        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          if(!draggingEl || draggingEl === el) return;
          el.classList.add('dragover');
        });

        el.addEventListener('dragleave', () => el.classList.remove('dragover'));

        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('dragover');
          if(!draggingEl || draggingEl === el) return;

          const rect = el.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);
          if(after) el.insertAdjacentElement('afterend', draggingEl);
          else el.insertAdjacentElement('beforebegin', draggingEl);
        });
      });
    }

    function persistOrderFromDOM(){
      if(currentCat === 'all') return;
      const ids = Array.from(grid.querySelectorAll('.card')).map(x => x.dataset.id);
      setOrder(currentCat, ids);
    }

    // ---------------------------
    // Counts
    // ---------------------------
    function updateCounts(){
      const cats = ['all','comm','prod','media','finance','ai','news','shop','community','dev','util'];
      const allItems = getItemsForCat('all');
      const counts = {};
      cats.forEach(c => counts[c] = 0);

      allItems.forEach(item => {
        counts['all'] += 1;
        if(counts[item.cat] !== undefined) counts[item.cat] += 1;
      });

      cats.forEach(c => {
        const el = document.querySelector(`[data-count="${c}"]`);
        if(el) el.textContent = `(${counts[c]})`;
      });
    }

    // ---------------------------
    // URL
    // ---------------------------
    function updateUrl(){
      const params = new URLSearchParams();
      if(currentCat !== 'all') params.set('cat', currentCat);
      const base = `${location.pathname}${params.toString() ? '?' + params.toString() : ''}`;
      const hash = location.hash || '';
      history.replaceState(null, '', base + hash);
    }
    function readUrl(){
      const params = new URLSearchParams(location.search);
      const cat = params.get('cat') || 'all';
      const exists = chips.some(c => c.dataset.cat === cat);
      setActiveChip(exists ? cat : 'all');
    }

    // ---------------------------
    // Category switch
    // ---------------------------
    function setActiveChip(cat){
      chips.forEach(c => c.classList.toggle('active', c.dataset.cat === cat));
      currentCat = cat;
      favScope.textContent = chipLabel(cat);
      updateUrl();
      renderGrid();
      renderFav();
    }
    chips.forEach(chip => chip.addEventListener('click', () => setActiveChip(chip.dataset.cat)));

    // ---------------------------
    // Buttons
    // ---------------------------
    function resetAll(){
      naverQ.value = '';
      googleQ.value = '';
      setActiveChip('all');
    }
    resetBtn.addEventListener('click', resetAll);

    resetOrderBtn.addEventListener('click', () => {
      if(currentCat === 'all') return;
      clearOrder(currentCat);
      renderGrid();
    });

    wipeBtn.addEventListener('click', () => {
      localStorage.removeItem(FAV_KEY);
      localStorage.removeItem(ORDER_KEY);
      localStorage.removeItem(CUSTOM_KEY);
      // also clear share hash
      history.replaceState(null,'', location.pathname + location.search);
      renderGrid(); renderFav(); syncStars();
    });

    addBtn.addEventListener('click', () => {
      if(currentCat === 'all'){
        openLinkModal('add', {cat:'comm',badge:'ME',title:'',sub:'',href:''});
      }else{
        openLinkModal('add', {cat:currentCat,badge:'ME',title:'',sub:'',href:''});
      }
    });

    // ---------------------------
    // Export / Import
    // ---------------------------
    exportBtn.addEventListener('click', () => {
      const payload = buildPersonalizationPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dashboard-personalization.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => openImportModal());

    function buildPersonalizationPayload(){
      return {
        v: 1,
        exportedAt: new Date().toISOString(),
        favorites: loadJSON(FAV_KEY, {}),
        order: loadJSON(ORDER_KEY, {}),
        customLinks: loadCustom(),
      };
    }

    function applyPersonalizationPayload(obj){
      const favorites = obj.favorites ?? {};
      const order = obj.order ?? {};
      const customLinks = obj.customLinks ?? [];

      if(typeof favorites !== 'object' || typeof order !== 'object' || !Array.isArray(customLinks)) return false;

      const sanitizedCustom = customLinks
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          id: String(x.id || uid()),
          cat: String(x.cat || 'comm'),
          badge: String(x.badge || 'ME').slice(0,10),
          title: String(x.title || '').slice(0,60),
          sub: String(x.sub || '').slice(0,80),
          href: safeUrl(String(x.href || '')) || 'https://example.com'
        }));

      saveJSON(FAV_KEY, favorites);
      saveJSON(ORDER_KEY, order);
      saveJSON(CUSTOM_KEY, sanitizedCustom);
      return true;
    }

    function openImportModal(){
      modalBack.style.display = 'flex';
      editingId = null;
      linkFormArea.style.display = 'none';
      importArea.style.display = 'block';
      modalTitle.textContent = '개인화 가져오기';
      modalDesc.textContent = 'JSON을 붙여넣고 가져오기 적용을 누르세요.';
      importText.value = '';
    }

    function applyImport(jsonText){
      let obj;
      try{ obj = JSON.parse(jsonText); }
      catch{ alert('JSON 파싱 실패'); return false; }

      const ok = applyPersonalizationPayload(obj);
      if(!ok){ alert('JSON 구조가 올바르지 않습니다.'); return false; }
      return true;
    }

    applyImportBtn.addEventListener('click', () => {
      const text = (importText.value || '').trim();
      if(!text){ alert('JSON을 붙여넣으세요.'); return; }
      if(!confirm('기존 개인화를 덮어쓰고 가져오겠습니까?')) return;

      const ok = applyImport(text);
      if(ok){
        closeModal();
        renderGrid(); renderFav(); syncStars();
      }
    });
    importCancelBtn.addEventListener('click', () => closeModal());

    // ---------------------------
    // Share link (serverless, URL hash)
    // ---------------------------
    shareBtn.addEventListener('click', async () => {
      const payload = buildPersonalizationPayload();
      const json = JSON.stringify(payload);
      const packed = toBase64Url(json);

      // current URL without existing hash
      const base = location.origin + location.pathname + location.search;
      const shareUrl = base + '#p=' + packed;

      try{
        await navigator.clipboard.writeText(shareUrl);
        alert('공유 링크가 클립보드에 복사되었습니다.');
      }catch{
        // fallback: prompt
        prompt('공유 링크를 복사하세요:', shareUrl);
      }
    });

    function tryApplyFromHash(){
      const hash = location.hash || '';
      if(!hash.startsWith('#p=')) return;

      const packed = hash.slice(3);
      if(!packed) return;

      let json;
      try{
        json = fromBase64Url(packed);
      }catch{
        alert('공유 링크 해석 실패(손상됨).');
        return;
      }

      let obj;
      try{ obj = JSON.parse(json); }
      catch{
        alert('공유 데이터 JSON 파싱 실패');
        return;
      }

      const ok = confirm('공유 링크의 개인화를 이 브라우저에 적용할까요? (기존 개인화는 덮어쓰기)');
      if(!ok) return;

      const applied = applyPersonalizationPayload(obj);
      if(!applied){
        alert('공유 데이터 구조가 올바르지 않습니다.');
        return;
      }

      // remove hash after applying
      history.replaceState(null,'', location.pathname + location.search);
      renderGrid(); renderFav(); syncStars();
      alert('적용 완료');
    }

    // ---------------------------
    // Link modal (add/edit)
    // ---------------------------
    function openLinkModal(mode, item){
      modalBack.style.display = 'flex';
      linkFormArea.style.display = 'block';
      importArea.style.display = 'none';

      editingId = (mode === 'edit') ? item.id : null;

      if(mode === 'edit'){
        modalTitle.textContent = '내 링크 편집';
        modalDesc.textContent = '이 링크는 브라우저에만 저장됩니다.';
        deleteBtn.style.display = 'inline-flex';
      }else{
        modalTitle.textContent = '내 링크 추가';
        modalDesc.textContent = '현재 선택된 카테고리에 저장됩니다.';
        deleteBtn.style.display = 'none';
      }

      fCat.value = item.cat || 'comm';
      fBadge.value = item.badge || 'ME';
      fTitle.value = item.title || '';
      fSub.value = item.sub || '';
      fHref.value = item.href || '';

      if(currentCat !== 'all') fCat.value = currentCat;
    }

    function closeModal(){
      modalBack.style.display = 'none';
      editingId = null;
      fTitle.value = '';
      fSub.value = '';
      fHref.value = '';
      fBadge.value = '';
      importText.value = '';
    }

    function validateForm(){
      const cat = fCat.value;
      const badge = (fBadge.value || '').trim().slice(0,10);
      const title = (fTitle.value || '').trim().slice(0,60);
      const sub = (fSub.value || '').trim().slice(0,80);
      const hrefRaw = (fHref.value || '').trim();

      if(!title) return {ok:false, msg:'이름을 입력하세요.'};
      const href = safeUrl(hrefRaw);
      if(!href) return {ok:false, msg:'URL은 http/https 형식만 허용됩니다.'};

      return {ok:true, data:{cat, badge, title, sub, href}};
    }

    saveBtn.addEventListener('click', () => {
      const v = validateForm();
      if(!v.ok){ alert(v.msg); return; }

      const item = v.data;
      if(editingId) upsertCustom({id:editingId, ...item});
      else upsertCustom({id:uid(), ...item});

      closeModal();
      renderGrid();
      updateCounts();
    });

    deleteBtn.addEventListener('click', () => {
      if(!editingId) return;
      if(!confirm('이 내 링크를 삭제할까요?')) return;
      deleteCustom(editingId);
      closeModal();
      renderGrid();
      updateCounts();
    });

    modalClose.addEventListener('click', closeModal);
    cancelBtn.addEventListener('click', closeModal);
    modalBack.addEventListener('click', (e) => { if(e.target === modalBack) closeModal(); });

    // ---------------------------
    // PWA install button
    // ---------------------------
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });

    installBtn.addEventListener('click', async () => {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      try{ await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });

    // ---------------------------
    // Service Worker register
    // ---------------------------
    async function registerSW(){
      if(!('serviceWorker' in navigator)) return;
      try{
        await navigator.serviceWorker.register('./sw.js');
      }catch(e){
        // fail silently
      }
    }

    // ---------------------------
    // URL state
    // ---------------------------
    function updateUrlStateOnly(){
      const params = new URLSearchParams(location.search);
      if(currentCat === 'all') params.delete('cat');
      else params.set('cat', currentCat);
      const base = location.pathname + (params.toString() ? '?' + params.toString() : '');
      history.replaceState(null,'', base + (location.hash || ''));
    }

    function setActiveChip(cat){
      chips.forEach(c => c.classList.toggle('active', c.dataset.cat === cat));
      currentCat = cat;
      favScope.textContent = chipLabel(cat);
      updateUrlStateOnly();
      renderGrid();
      renderFav();
    }

    // ---------------------------
    // Init
    // ---------------------------
    function initChips(){
      chips.forEach(chip => chip.addEventListener('click', () => setActiveChip(chip.dataset.cat)));
      const params = new URLSearchParams(location.search);
      const cat = params.get('cat') || 'all';
      const exists = chips.some(c => c.dataset.cat === cat);
      setActiveChip(exists ? cat : 'all');
    }

    resetBtn.addEventListener('click', resetAll);

    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        if(modalBack.style.display === 'flex') closeModal();
        else resetAll();
      }
    });

    // boot
    registerSW();
    initChips();
    renderFav();
    renderGrid();
    tryApplyFromHash(); // if opened via share link
  </script>
</body>
</html>
