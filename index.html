<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>미니멀 링크 대시보드</title>

  <!-- (선택) PWA: 같은 폴더에 manifest.json / sw.js가 있으면 동작 -->
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#ffffff" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />

  <!-- Minimal favicon -->
  <link rel="icon" type="image/svg+xml"
    href='data:image/svg+xml,%3Csvg xmlns="http://www.w3.org/2000/svg" width="128" height="128"%3E%3Crect width="128" height="128" rx="28" fill="%23ffffff"/%3E%3Cpath d="M36 40h56v10H36zM36 59h40v10H36zM36 78h56v10H36z" fill="%23111827"/%3E%3C/svg%3E' />

  <style>
    :root{
      --bg:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --card:#ffffff;
      --hover:#f9fafb;
      --chip:#f3f4f6;
      --shadow: 0 10px 30px rgba(17,24,39,.06);
      --radius:16px;
      --max:1200px;

      --warn:#ef4444;
      --gold:#f59e0b;
      --ok:#10b981;
    }
    [data-theme="dark"]{
      --bg:#0b1220;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:#1f2937;
      --card:#0f172a;
      --hover:#111c33;
      --chip:#111c33;
      --shadow: 0 16px 36px rgba(0,0,0,.35);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial, sans-serif;
      background:var(--bg);
      color:var(--text);
    }

    .wrap{
      max-width:var(--max);
      margin:0 auto;
      padding:28px 16px 56px;
    }

    /* Layout */
    .layout{
      display:grid;
      grid-template-columns: 1.65fr 1fr; /* left / right */
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr; }
    }

    /* Header */
    .top{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:14px;
    }
    .brand h1{
      font-size:30px;
      letter-spacing:-0.02em;
      margin:0 0 6px 0;
      line-height:1.15;
      word-break:keep-all;
    }
    .brand p{
      margin:0;
      color:var(--muted);
      line-height:1.5;
      font-size:14px;
    }

    /* Buttons */
    .actions{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
    }
    .btn{
      border:1px solid var(--line);
      background:var(--card);
      padding:10px 12px;
      border-radius:12px;
      font-weight:900;
      font-size:13px;
      cursor:pointer;
      color:var(--text);
      white-space:nowrap;
    }
    .btn:hover{background:var(--hover);}
    .btn.primary{
      border-color: rgba(16,185,129,.35);
      background: rgba(16,185,129,.10);
    }
    .btn.danger{
      border-color: rgba(239,68,68,.35);
      background: rgba(239,68,68,.08);
    }

    /* Search rows */
    .searchRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:12px;
    }
    @media (max-width:820px){
      .searchRow{grid-template-columns:1fr;}
    }
    .search{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      display:flex;
      gap:10px;
      align-items:center;
      background:var(--card);
      box-shadow: var(--shadow);
    }
    .search .icon{
      width:36px;height:36px;border-radius:12px;
      background:var(--chip);
      display:flex;align-items:center;justify-content:center;
      color:var(--muted);
      font-weight:950;
      flex:0 0 auto;
      border:1px solid var(--line);
    }
    .search input{
      border:0;
      outline:none;
      width:100%;
      font-size:15px;
      background:transparent;
      color:var(--text);
    }

    .hint{
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
      line-height:1.5;
    }

    /* Favorites */
    .favBox{
      margin-top:14px;
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .favTop{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .favTitle{
      font-weight:950;
      letter-spacing:-0.01em;
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .pill{
      font-size:12px;
      font-weight:950;
      border:1px solid var(--line);
      background:var(--chip);
      padding:6px 10px;
      border-radius:999px;
      color:var(--text);
      flex:0 0 auto;
    }
    .favHelp{
      color:var(--muted);
      font-size:12px;
      line-height:1.4;
      margin-top:6px;
    }
    .favGrid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap:10px;
      margin-top:10px;
    }
    .favItem{
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px;
      background:var(--card);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      min-height:54px;
    }
    .favItem[draggable="true"]{cursor:grab;}
    .favItem.dragging{opacity:.55;}
    .favItem.dragover{
      outline: 2px dashed rgba(16,185,129,.65);
      outline-offset: 2px;
    }
    .favLeft{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:4px;
    }
    .favLink{
      text-decoration:none;
      color:var(--text);
      font-weight:900;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
      display:block;
    }
    .favMeta{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width:100%;
    }
    .iconBtn{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--chip);
      cursor:pointer;
      font-weight:950;
      color:var(--text);
      display:flex;
      align-items:center;
      justify-content:center;
      user-select:none;
      flex:0 0 auto;
    }
    .iconBtn:hover{background:var(--hover);}
    .iconBtn.danger{color:var(--warn);}

    /* Categories */
    .cats{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin:16px 0 12px;
    }
    .chipbtn{
      border:1px solid var(--line);
      background:var(--chip);
      padding:8px 12px;
      border-radius:999px;
      font-size:13px;
      font-weight:950;
      color:var(--text);
      cursor:pointer;
      user-select:none;
      display:flex;
      align-items:center;
      gap:6px;
    }
    .chipbtn:hover{background:var(--hover);}
    .chipbtn.active{
      background:var(--text);
      color:var(--bg);
      border-color:var(--text);
    }
    .count{
      font-size:12px;
      font-weight:950;
      opacity:.75;
    }

    /* Grid cards */
    .grid{
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      gap:14px;
      margin-top:12px;
    }
    @media (max-width:520px){
      .brand h1{font-size:24px;}
      .grid{grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));}
      .favGrid{grid-template-columns: repeat(auto-fill, minmax(170px, 1fr));}
      .actions{gap:8px;}
    }

    .card{
      display:grid;
      grid-template-columns: 1fr auto auto;
      align-items:center;
      gap:10px;
      padding:16px;
      border-radius:var(--radius);
      border:1px solid var(--line);
      background:var(--card);
      text-decoration:none;
      color:var(--text);
      transition: transform .12s ease, background .12s ease, box-shadow .12s ease;
      min-height:86px;
      box-shadow: 0 0 0 rgba(0,0,0,0);
    }
    .card:hover{
      background:var(--hover);
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(17,24,39,.08);
    }
    .card[draggable="true"]{cursor:grab;}
    .card.dragging{opacity:.55; transform:none;}
    .card.dragover{
      outline: 2px dashed rgba(16,185,129,.65);
      outline-offset: 2px;
    }

    .left{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }
    .title{
      font-weight:980;
      letter-spacing:-0.01em;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .sub{
      color:var(--muted);
      font-size:12px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .metaRow{
      display:flex;
      gap:8px;
      align-items:center;
      min-width:0;
    }
    .badge{
      flex:0 0 auto;
      font-size:12px;
      font-weight:950;
      color:var(--text);
      background:var(--chip);
      border:1px solid var(--line);
      padding:6px 10px;
      border-radius:999px;
      max-width: 100%;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    .star, .menu{
      width:34px;height:34px;
      border-radius:12px;
      border:1px solid var(--line);
      background:var(--chip);
      cursor:pointer;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:980;
      user-select:none;
      color:var(--muted);
    }
    .star:hover,.menu:hover{background:var(--hover);}
    .star.on{
      color:var(--gold);
      border-color: rgba(245, 158, 11, .35);
    }
    .menu.hidden{display:none;}

    /* Right panel cards */
    .side{
      position:sticky;
      top:16px;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    @media (max-width:980px){
      .side{position:static;}
    }
    .panel{
      border:1px solid var(--line);
      border-radius:16px;
      background:var(--card);
      box-shadow: var(--shadow);
      padding:14px;
    }
    .panelTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .panelTitle{
      font-weight:950;
      letter-spacing:-0.01em;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .panelBody{
      display:flex;
      flex-direction:column;
      gap:10px;
    }
    .iframeWrap{
      border:1px solid var(--line);
      border-radius:14px;
      overflow:hidden;
      background:var(--bg);
    }
    iframe{
      width:100%;
      height:520px;
      border:0;
      display:block;
    }
    .miniHelp{
      color:var(--muted);
      font-size:12px;
      line-height:1.5;
    }

    /* Todo */
    .todoRow{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .todoRow input{
      flex:1;
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-weight:800;
      font-size:14px;
    }
    .todoList{
      display:flex;
      flex-direction:column;
      gap:8px;
      margin-top:6px;
    }
    .todoItem{
      border:1px solid var(--line);
      background:var(--card);
      border-radius:14px;
      padding:10px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .todoItem[draggable="true"]{cursor:grab;}
    .todoItem.dragging{opacity:.55;}
    .todoItem.dragover{
      outline: 2px dashed rgba(16,185,129,.65);
      outline-offset: 2px;
    }
    .todoLeft{
      display:flex;
      align-items:center;
      gap:10px;
      min-width:0;
    }
    .todoCheck{
      width:18px;height:18px;
      accent-color: var(--ok);
      cursor:pointer;
    }
    .todoText{
      font-weight:900;
      font-size:14px;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      max-width: 100%;
    }
    .todoText.done{
      color:var(--muted);
      text-decoration: line-through;
      font-weight:850;
    }

    /* Modal */
    .modalBack{
      position:fixed;
      inset:0;
      background: rgba(0,0,0,.35);
      display:none;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:50;
    }
    .modal{
      width:min(640px, 100%);
      background:var(--card);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px;
    }
    .modalHeader{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    .modalTitle{font-weight:980; letter-spacing:-0.01em;}
    .form{
      display:flex;
      flex-direction:column;
      gap:10px;
      margin-top:10px;
    }
    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .field label{
      font-size:12px;
      color:var(--muted);
      font-weight:900;
    }
    .field input, .field select, .field textarea{
      border:1px solid var(--line);
      background:var(--bg);
      color:var(--text);
      border-radius:12px;
      padding:12px 12px;
      outline:none;
      font-weight:800;
      font-size:14px;
    }
    .field textarea{
      min-height:160px;
      resize:vertical;
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:12px;
      font-weight:700;
      line-height:1.45;
    }
    .row2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width:820px){
      .row2{grid-template-columns:1fr;}
    }
    .modalActions{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      margin-top:12px;
      flex-wrap:wrap;
    }
    .small{
      font-size:12px;
      color:var(--muted);
      line-height:1.45;
      margin-top:8px;
    }

    footer{
      margin-top:22px;
      padding-top:18px;
      border-top:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      line-height:1.7;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <h1>미니멀 링크 대시보드</h1>
        <p>무회원 · 무수집 · 개인화는 브라우저에만 저장됩니다. (공유는 URL로만 전달)</p>
      </div>

      <div class="searchRow">
        <div class="search" title="네이버 검색 (Enter)">
          <div class="icon">N</div>
          <input id="naverQ" placeholder="네이버 검색 (Enter)" autocomplete="off" />
          <button class="btn" type="button" id="naverGo">검색</button>
        </div>

        <div class="search" title="구글 검색 (Enter)">
          <div class="icon">G</div>
          <input id="googleQ" placeholder="구글 검색 (Enter)" autocomplete="off" />
          <button class="btn" type="button" id="googleGo">검색</button>
        </div>
      </div>

      <div class="hint">
        • ⭐: 전역 즐겨찾기 • 즐겨찾기/카드 모두 드래그로 순서 저장 • ⋯: 내 링크 편집/삭제 • 공유 링크: 서버 없이 URL로 전달(압축)
      </div>
    </div>

    <div class="layout">
      <!-- LEFT -->
      <div class="main">
        <!-- Favorites (with moved actions + theme toggle) -->
        <div class="favBox">
          <div class="favTop">
            <div>
              <div class="favTitle">
                <span>즐겨찾기</span>
                <span class="pill">전역</span>
              </div>
              <div class="favHelp">카테고리와 무관하게 한 곳에 저장됩니다. (드래그로 순서 변경)</div>
            </div>

            <div class="actions">
              <button class="btn" id="themeBtn" type="button" title="화이트/블랙 토글">화이트/블랙</button>

              <button class="btn primary" id="addBtn" type="button">내 링크 추가</button>
              <button class="btn" id="resetOrderBtn" type="button">정렬 초기화</button>
              <button class="btn" id="exportBtn" type="button">내보내기</button>
              <button class="btn" id="importBtn" type="button">가져오기</button>
              <button class="btn danger" id="wipeBtn" type="button">개인화 초기화</button>
              <button class="btn" id="shareBtn" type="button" title="현재 개인화를 URL로 공유">공유 링크(압축)</button>
              <button class="btn" id="installBtn" type="button" style="display:none;">홈화면 설치</button>
              <button class="btn" type="button" id="resetBtn">초기화</button>
            </div>
          </div>

          <div class="favGrid" id="favGrid"></div>
        </div>

        <!-- Categories -->
        <div class="cats" id="cats">
          <div class="chipbtn active" data-cat="all">전체 <span class="count" data-count="all">(0)</span></div>
          <div class="chipbtn" data-cat="comm">커뮤니케이션 <span class="count" data-count="comm">(0)</span></div>
          <div class="chipbtn" data-cat="prod">생산성 <span class="count" data-count="prod">(0)</span></div>
          <div class="chipbtn" data-cat="media">미디어 <span class="count" data-count="media">(0)</span></div>
          <div class="chipbtn" data-cat="finance">금융 <span class="count" data-count="finance">(0)</span></div>
          <div class="chipbtn" data-cat="ai">AI <span class="count" data-count="ai">(0)</span></div>
          <div class="chipbtn" data-cat="news">뉴스·리서치 <span class="count" data-count="news">(0)</span></div>
          <div class="chipbtn" data-cat="shop">쇼핑 <span class="count" data-count="shop">(0)</span></div>
          <div class="chipbtn" data-cat="community">커뮤니티 <span class="count" data-count="community">(0)</span></div>
          <div class="chipbtn" data-cat="dev">개발·도구 <span class="count" data-count="dev">(0)</span></div>
          <div class="chipbtn" data-cat="util">유틸리티 <span class="count" data-count="util">(0)</span></div>
        </div>

        <!-- Grid -->
        <div class="grid" id="grid"></div>

        <footer>
          본 사이트는 링크 허브(북마크 대체)입니다. 외부 서비스의 상표/운영 권한은 각 소유자에게 있습니다.<br/>
          회원가입/로그인 없음, 개인정보 수집/저장 없음. 개인화(즐겨찾기/정렬/내 링크/캘린더/투두)는 브라우저(LocalStorage)에만 저장됩니다.
        </footer>
      </div>

      <!-- RIGHT -->
      <aside class="side">
        <!-- Google Calendar -->
        <section class="panel">
          <div class="panelTop">
            <div class="panelTitle">
              <span>Google Calendar</span>
              <span class="pill">임베드</span>
            </div>
            <div class="actions">
              <button class="btn" id="calSettingBtn" type="button">연동 설정</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="iframeWrap">
              <iframe id="calFrame" title="Google Calendar"></iframe>
            </div>
            <div class="miniHelp">
              • “연동”은 Google Calendar의 <b>공개 임베드 URL</b> 또는 <b>캘린더 ID</b>를 저장해 불러오는 방식입니다.<br/>
              • 개인 계정의 비공개 캘린더를 “자동 로그인 연동”하려면 OAuth가 필요하며, 이 단일 HTML(무서버) 구조에서는 지원하지 않습니다.
            </div>
          </div>
        </section>

        <!-- Todo -->
        <section class="panel">
          <div class="panelTop">
            <div class="panelTitle">
              <span>To-Do</span>
              <span class="pill">로컬</span>
            </div>
            <div class="actions">
              <button class="btn danger" id="todoClearBtn" type="button">완료삭제</button>
            </div>
          </div>
          <div class="panelBody">
            <div class="todoRow">
              <input id="todoInput" placeholder="할 일 입력 후 Enter" autocomplete="off"/>
              <button class="btn primary" id="todoAddBtn" type="button">추가</button>
            </div>
            <div class="todoList" id="todoList"></div>
            <div class="miniHelp">• 체크/드래그로 관리됩니다. (브라우저에만 저장)</div>
          </div>
        </section>
      </aside>
    </div>
  </div>

  <!-- Modal: link add/edit OR import JSON OR calendar setting -->
  <div class="modalBack" id="modalBack" role="dialog" aria-modal="true">
    <div class="modal">
      <div class="modalHeader">
        <div class="modalTitle" id="modalTitle">내 링크 추가</div>
        <button class="iconBtn" id="modalClose" type="button" title="닫기">×</button>
      </div>

      <div class="small" id="modalDesc"></div>

      <!-- Link form -->
      <div id="linkFormArea">
        <div class="form">
          <div class="row2">
            <div class="field">
              <label>카테고리</label>
              <select id="fCat">
                <option value="comm">커뮤니케이션</option>
                <option value="prod">생산성</option>
                <option value="media">미디어</option>
                <option value="finance">금융</option>
                <option value="ai">AI</option>
                <option value="news">뉴스·리서치</option>
                <option value="shop">쇼핑</option>
                <option value="community">커뮤니티</option>
                <option value="dev">개발·도구</option>
                <option value="util">유틸리티</option>
              </select>
            </div>
            <div class="field">
              <label>뱃지(표시)</label>
              <input id="fBadge" placeholder="예: ME / PRO / FIN" />
            </div>
          </div>

          <div class="field">
            <label>이름</label>
            <input id="fTitle" placeholder="예: 내 서비스" />
          </div>

          <div class="field">
            <label>설명</label>
            <input id="fSub" placeholder="예: 메모" />
          </div>

          <div class="field">
            <label>URL</label>
            <input id="fHref" placeholder="https://..." />
          </div>
        </div>

        <div class="modalActions">
          <button class="btn danger" id="deleteBtn" type="button" style="display:none;">삭제</button>
          <button class="btn" id="cancelBtn" type="button">취소</button>
          <button class="btn primary" id="saveBtn" type="button">저장</button>
        </div>
      </div>

      <!-- Import area -->
      <div id="importArea" style="display:none;">
        <div class="form">
          <div class="field">
            <label>가져오기 JSON</label>
            <textarea id="importText" placeholder='여기에 JSON을 붙여넣고 "가져오기 적용"을 누르세요.'></textarea>
          </div>
        </div>
        <div class="modalActions">
          <button class="btn" id="importCancelBtn" type="button">취소</button>
          <button class="btn primary" id="applyImportBtn" type="button">가져오기 적용</button>
        </div>
        <div class="small">주의: 기존 개인화(내 링크/정렬/즐겨찾기/캘린더/투두)를 덮어씁니다.</div>
      </div>

      <!-- Calendar setting area -->
      <div id="calArea" style="display:none;">
        <div class="form">
          <div class="field">
            <label>방식 1) Google Calendar 임베드 URL (권장)</label>
            <input id="calEmbedUrl" placeholder="https://calendar.google.com/calendar/embed?..." />
            <div class="small">
              Google Calendar → 설정 → “캘린더 통합” → “임베드 코드”에서 src URL을 복사해 넣으세요.
              (공개 캘린더 또는 조직 정책상 허용된 캘린더만 표시됩니다.)
            </div>
          </div>

          <div class="field">
            <label>방식 2) 캘린더 ID로 생성 (간단)</label>
            <input id="calId" placeholder="예: yourname@gmail.com 또는 ...@group.calendar.google.com" />
            <div class="small">
              이 방식은 기본 임베드 URL을 만들어 적용합니다(주로 공개/공유 캘린더용).
            </div>
          </div>
        </div>

        <div class="modalActions">
          <button class="btn danger" id="calResetBtn" type="button">캘린더 초기화</button>
          <button class="btn" id="calCancelBtn" type="button">취소</button>
          <button class="btn primary" id="calSaveBtn" type="button">저장</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------------------------
    // Keys
    // ---------------------------
    const FAV_KEY    = 'xbrand_favorites_global_v2';
    const ORDER_KEY  = 'xbrand_order_v2';
    const CUSTOM_KEY = 'xbrand_custom_links_v2';
    const TODO_KEY   = 'xbrand_todo_v1';
    const THEME_KEY  = 'xbrand_theme_v1';
    const CAL_KEY    = 'xbrand_calendar_v1';

    // ---------------------------
    // Helpers
    // ---------------------------
    function escapeHtml(str){
      return String(str)
        .replaceAll('&','&amp;')
        .replaceAll('<','&lt;')
        .replaceAll('>','&gt;')
        .replaceAll('"','&quot;')
        .replaceAll("'","&#039;");
    }
    function safeUrl(url){
      try{
        const u = new URL(url);
        if(u.protocol !== 'http:' && u.protocol !== 'https:') return null;
        return u.toString();
      }catch{ return null; }
    }
    function loadJSON(key, fallback){
      try{ return JSON.parse(localStorage.getItem(key) || '') ?? fallback; }
      catch{ return fallback; }
    }
    function saveJSON(key, val){
      localStorage.setItem(key, JSON.stringify(val));
    }
    function uid(){
      return 'id_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
    }
    function chipLabel(cat){
      const map = {
        all:'전체', comm:'커뮤니케이션', prod:'생산성', media:'미디어', finance:'금융', ai:'AI',
        news:'뉴스·리서치', shop:'쇼핑', community:'커뮤니티', dev:'개발·도구', util:'유틸리티'
      };
      return map[cat] || cat;
    }

    // ---------------------------
    // URL-safe compression (LZ-based)
    // ---------------------------
    const _keyStrUriSafe = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+-$";
    function _getBaseValue(alphabet, character) { return alphabet.indexOf(character); }
    function compressToEncodedURIComponent(input) {
      if (input == null) return "";
      return _compress(input, 6, (a) => _keyStrUriSafe.charAt(a));
    }
    function decompressFromEncodedURIComponent(input) {
      if (input == null) return "";
      if (input === "") return null;
      return _decompress(input.length, 32, (index) => _getBaseValue(_keyStrUriSafe, input.charAt(index)));
    }
    function _compress(uncompressed, bitsPerChar, getCharFromInt) {
      if (uncompressed == null) return "";
      let i, value;
      const context_dictionary = {};
      const context_dictionaryToCreate = {};
      let context_c = "";
      let context_wc = "";
      let context_w = "";
      let context_enlargeIn = 2;
      let context_dictSize = 3;
      let context_numBits = 2;
      const context_data = [];
      let context_data_val = 0;
      let context_data_position = 0;

      for (let ii = 0; ii < uncompressed.length; ii += 1) {
        context_c = uncompressed.charAt(ii);
        if (!Object.prototype.hasOwnProperty.call(context_dictionary, context_c)) {
          context_dictionary[context_c] = context_dictSize++;
          context_dictionaryToCreate[context_c] = true;
        }
        context_wc = context_w + context_c;
        if (Object.prototype.hasOwnProperty.call(context_dictionary, context_wc)) {
          context_w = context_wc;
        } else {
          if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
            if (context_w.charCodeAt(0) < 256) {
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else context_data_position++;
              }
              value = context_w.charCodeAt(0);
              for (i = 0; i < 8; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else context_data_position++;
                value = value >> 1;
              }
            } else {
              value = 1;
              for (i = 0; i < context_numBits; i++) {
                context_data_val = (context_data_val << 1) | value;
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else context_data_position++;
                value = 0;
              }
              value = context_w.charCodeAt(0);
              for (i = 0; i < 16; i++) {
                context_data_val = (context_data_val << 1) | (value & 1);
                if (context_data_position == bitsPerChar - 1) {
                  context_data_position = 0;
                  context_data.push(getCharFromInt(context_data_val));
                  context_data_val = 0;
                } else context_data_position++;
                value = value >> 1;
              }
            }
            context_enlargeIn--;
            if (context_enlargeIn == 0) {
              context_enlargeIn = Math.pow(2, context_numBits);
              context_numBits++;
            }
            delete context_dictionaryToCreate[context_w];
          } else {
            value = context_dictionary[context_w];
            for (i = 0; i < context_numBits; i++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else context_data_position++;
              value = value >> 1;
            }
          }
          context_enlargeIn--;
          if (context_enlargeIn == 0) {
            context_enlargeIn = Math.pow(2, context_numBits);
            context_numBits++;
          }
          context_dictionary[context_wc] = context_dictSize++;
          context_w = String(context_c);
        }
      }

      if (context_w !== "") {
        if (Object.prototype.hasOwnProperty.call(context_dictionaryToCreate, context_w)) {
          if (context_w.charCodeAt(0) < 256) {
            for (i = 0; i < context_numBits; i++) {
              context_data_val = (context_data_val << 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else context_data_position++;
            }
            value = context_w.charCodeAt(0);
            for (i = 0; i < 8; i++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else context_data_position++;
              value = value >> 1;
            }
          } else {
            value = 1;
            for (i = 0; i < context_numBits; i++) {
              context_data_val = (context_data_val << 1) | value;
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else context_data_position++;
              value = 0;
            }
            value = context_w.charCodeAt(0);
            for (i = 0; i < 16; i++) {
              context_data_val = (context_data_val << 1) | (value & 1);
              if (context_data_position == bitsPerChar - 1) {
                context_data_position = 0;
                context_data.push(getCharFromInt(context_data_val));
                context_data_val = 0;
              } else context_data_position++;
              value = value >> 1;
            }
          }
          context_enlargeIn--;
          if (context_enlargeIn == 0) {
            context_enlargeIn = Math.pow(2, context_numBits);
            context_numBits++;
          }
          delete context_dictionaryToCreate[context_w];
        } else {
          value = context_dictionary[context_w];
          for (i = 0; i < context_numBits; i++) {
            context_data_val = (context_data_val << 1) | (value & 1);
            if (context_data_position == bitsPerChar - 1) {
              context_data_position = 0;
              context_data.push(getCharFromInt(context_data_val));
              context_data_val = 0;
            } else context_data_position++;
            value = value >> 1;
          }
        }
        context_enlargeIn--;
        if (context_enlargeIn == 0) {
          context_enlargeIn = Math.pow(2, context_numBits);
          context_numBits++;
        }
      }

      value = 2;
      for (i = 0; i < context_numBits; i++) {
        context_data_val = (context_data_val << 1) | (value & 1);
        if (context_data_position == bitsPerChar - 1) {
          context_data_position = 0;
          context_data.push(getCharFromInt(context_data_val));
          context_data_val = 0;
        } else context_data_position++;
        value = value >> 1;
      }

      while (true) {
        context_data_val = (context_data_val << 1);
        if (context_data_position == bitsPerChar - 1) {
          context_data.push(getCharFromInt(context_data_val));
          break;
        } else context_data_position++;
      }
      return context_data.join("");
    }
    function _decompress(length, resetValue, getNextValue) {
      const dictionary = [];
      let next;
      let enlargeIn = 4;
      let dictSize = 4;
      let numBits = 3;
      let entry = "";
      const result = [];
      let i;
      let w;
      let bits, resb, maxpower, power;
      let c;
      const data = { val: getNextValue(0), position: resetValue, index: 1 };

      for (i = 0; i < 3; i += 1) dictionary[i] = i;

      bits = 0; maxpower = Math.pow(2, 2); power = 1;
      while (power != maxpower) {
        resb = data.val & data.position;
        data.position >>= 1;
        if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
        bits |= (resb > 0 ? 1 : 0) * power;
        power <<= 1;
      }

      switch (next = bits) {
        case 0:
          bits = 0; maxpower = Math.pow(2, 8); power = 1;
          while (power != maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
          }
          c = String.fromCharCode(bits);
          break;
        case 1:
          bits = 0; maxpower = Math.pow(2, 16); power = 1;
          while (power != maxpower) {
            resb = data.val & data.position;
            data.position >>= 1;
            if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
            bits |= (resb > 0 ? 1 : 0) * power;
            power <<= 1;
          }
          c = String.fromCharCode(bits);
          break;
        case 2:
          return "";
      }

      dictionary[3] = c;
      w = c;
      result.push(c);

      while (true) {
        if (data.index > length) return "";

        bits = 0; maxpower = Math.pow(2, numBits); power = 1;
        while (power != maxpower) {
          resb = data.val & data.position;
          data.position >>= 1;
          if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
          bits |= (resb > 0 ? 1 : 0) * power;
          power <<= 1;
        }

        switch (c = bits) {
          case 0:
            bits = 0; maxpower = Math.pow(2, 8); power = 1;
            while (power != maxpower) {
              resb = data.val & data.position;
              data.position >>= 1;
              if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
              bits |= (resb > 0 ? 1 : 0) * power;
              power <<= 1;
            }
            dictionary[dictSize++] = String.fromCharCode(bits);
            c = dictSize - 1;
            enlargeIn--;
            break;
          case 1:
            bits = 0; maxpower = Math.pow(2, 16); power = 1;
            while (power != maxpower) {
              resb = data.val & data.position;
              data.position >>= 1;
              if (data.position == 0) { data.position = resetValue; data.val = getNextValue(data.index++); }
              bits |= (resb > 0 ? 1 : 0) * power;
              power <<= 1;
            }
            dictionary[dictSize++] = String.fromCharCode(bits);
            c = dictSize - 1;
            enlargeIn--;
            break;
          case 2:
            return result.join("");
        }

        if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }

        if (dictionary[c]) entry = dictionary[c];
        else {
          if (c === dictSize) entry = w + w.charAt(0);
          else return null;
        }
        result.push(entry);

        dictionary[dictSize++] = w + entry.charAt(0);
        enlargeIn--;
        w = entry;

        if (enlargeIn == 0) { enlargeIn = Math.pow(2, numBits); numBits++; }
      }
    }

    // ---------------------------
    // Base links (추천)
    // ---------------------------
    const BASE = [
      // comm
      {id:'b_comm_1',cat:'comm',title:'Telegram Web',sub:'메신저',href:'https://web.telegram.org',badge:'COMM'},
      {id:'b_comm_2',cat:'comm',title:'Discord',sub:'커뮤니티/채팅',href:'https://discord.com/app',badge:'COMM'},
      {id:'b_comm_3',cat:'comm',title:'Slack',sub:'업무 메신저',href:'https://slack.com/signin',badge:'COMM'},
      {id:'b_comm_4',cat:'comm',title:'Gmail',sub:'메일',href:'https://mail.google.com',badge:'COMM'},
      {id:'b_comm_5',cat:'comm',title:'Kakao OpenChat',sub:'오픈채팅',href:'https://open.kakao.com',badge:'COMM'},
      {id:'b_comm_6',cat:'comm',title:'Naver',sub:'포털',href:'https://www.naver.com',badge:'COMM'},
      {id:'b_comm_7',cat:'comm',title:'Google Account',sub:'계정',href:'https://accounts.google.com',badge:'COMM'},

      // prod
      {id:'b_prod_1',cat:'prod',title:'Notion',sub:'문서 · 위키',href:'https://www.notion.so',badge:'PROD'},
      {id:'b_prod_2',cat:'prod',title:'Google Docs',sub:'문서',href:'https://docs.google.com',badge:'PROD'},
      {id:'b_prod_3',cat:'prod',title:'Google Sheets',sub:'스프레드시트',href:'https://sheets.google.com',badge:'PROD'},
      {id:'b_prod_4',cat:'prod',title:'Google Drive',sub:'파일',href:'https://drive.google.com',badge:'PROD'},
      {id:'b_prod_5',cat:'prod',title:'Google Calendar',sub:'일정',href:'https://calendar.google.com',badge:'PROD'},
      {id:'b_prod_6',cat:'prod',title:'Figma',sub:'디자인',href:'https://www.figma.com',badge:'PROD'},
      {id:'b_prod_7',cat:'prod',title:'Trello',sub:'칸반',href:'https://trello.com',badge:'PROD'},
      {id:'b_prod_8',cat:'prod',title:'Canva',sub:'템플릿',href:'https://www.canva.com',badge:'PROD'},

      // media
      {id:'b_media_1',cat:'media',title:'YouTube',sub:'동영상',href:'https://www.youtube.com',badge:'MEDIA'},
      {id:'b_media_2',cat:'media',title:'Netflix',sub:'스트리밍',href:'https://www.netflix.com',badge:'MEDIA'},
      {id:'b_media_3',cat:'media',title:'Naver Webtoon',sub:'웹툰',href:'https://comic.naver.com',badge:'MEDIA'},
      {id:'b_media_4',cat:'media',title:'Spotify',sub:'음악',href:'https://www.spotify.com',badge:'MEDIA'},

      // finance
      {id:'b_fin_1',cat:'finance',title:'TradingView',sub:'차트',href:'https://www.tradingview.com',badge:'FIN'},
      {id:'b_fin_2',cat:'finance',title:'Bitget',sub:'거래소',href:'https://www.bitget.com',badge:'FIN'},
      {id:'b_fin_3',cat:'finance',title:'Binance',sub:'거래소',href:'https://www.binance.com',badge:'FIN'},
      {id:'b_fin_4',cat:'finance',title:'CoinMarketCap',sub:'시총',href:'https://www.coinmarketcap.com',badge:'FIN'},
      {id:'b_fin_5',cat:'finance',title:'CoinGecko',sub:'데이터',href:'https://www.coingecko.com',badge:'FIN'},
      {id:'b_fin_6',cat:'finance',title:'Google Finance',sub:'시장',href:'https://www.google.com/finance',badge:'FIN'},

      // ai
      {id:'b_ai_1',cat:'ai',title:'ChatGPT',sub:'대화형 AI',href:'https://chat.openai.com',badge:'AI'},
      {id:'b_ai_2',cat:'ai',title:'Claude',sub:'대화형 AI',href:'https://claude.ai',badge:'AI'},
      {id:'b_ai_3',cat:'ai',title:'Gemini',sub:'구글 AI',href:'https://gemini.google.com',badge:'AI'},
      {id:'b_ai_4',cat:'ai',title:'Perplexity',sub:'AI 검색',href:'https://www.perplexity.ai',badge:'AI'},
      {id:'b_ai_5',cat:'ai',title:'Hugging Face',sub:'모델/데이터',href:'https://huggingface.co',badge:'AI'},

      // news
      {id:'b_news_1',cat:'news',title:'Naver News',sub:'뉴스',href:'https://news.naver.com',badge:'NEWS'},
      {id:'b_news_2',cat:'news',title:'Google News',sub:'뉴스',href:'https://news.google.com',badge:'NEWS'},
      {id:'b_news_3',cat:'news',title:'Reuters',sub:'글로벌',href:'https://www.reuters.com',badge:'NEWS'},
      {id:'b_news_4',cat:'news',title:'arXiv',sub:'논문',href:'https://arxiv.org',badge:'NEWS'},

      // shop
      {id:'b_shop_1',cat:'shop',title:'Coupang',sub:'쇼핑',href:'https://www.coupang.com',badge:'SHOP'},
      {id:'b_shop_2',cat:'shop',title:'Naver Shopping',sub:'가격비교',href:'https://shopping.naver.com',badge:'SHOP'},
      {id:'b_shop_3',cat:'shop',title:'Amazon',sub:'해외',href:'https://www.amazon.com',badge:'SHOP'},

      // community
      {id:'b_comu_1',cat:'community',title:'FMKOREA',sub:'커뮤니티',href:'https://www.fmkorea.com',badge:'COMM'},
      {id:'b_comu_2',cat:'community',title:'Clien',sub:'커뮤니티',href:'https://www.clien.net',badge:'COMM'},
      {id:'b_comu_3',cat:'community',title:'Reddit',sub:'글로벌',href:'https://www.reddit.com',badge:'COMM'},
      {id:'b_comu_4',cat:'community',title:'Namu Wiki',sub:'위키',href:'https://namu.wiki',badge:'COMM'},

      // dev
      {id:'b_dev_1',cat:'dev',title:'GitHub',sub:'코드',href:'https://github.com',badge:'DEV'},
      {id:'b_dev_2',cat:'dev',title:'Vercel',sub:'배포',href:'https://vercel.com',badge:'DEV'},
      {id:'b_dev_3',cat:'dev',title:'Stack Overflow',sub:'Q&A',href:'https://stackoverflow.com',badge:'DEV'},
      {id:'b_dev_4',cat:'dev',title:'Postman',sub:'API',href:'https://www.postman.com',badge:'DEV'},
      {id:'b_dev_5',cat:'dev',title:'Cloudflare',sub:'CDN',href:'https://cloudflare.com',badge:'DEV'},

      // util
      {id:'b_util_1',cat:'util',title:'Google Translate',sub:'번역',href:'https://translate.google.com',badge:'UTIL'},
      {id:'b_util_2',cat:'util',title:'Google Keep',sub:'메모',href:'https://keep.google.com',badge:'UTIL'},
      {id:'b_util_3',cat:'util',title:'Naver Map',sub:'지도',href:'https://map.naver.com',badge:'UTIL'},
      {id:'b_util_4',cat:'util',title:'Naver Weather',sub:'날씨',href:'https://weather.naver.com',badge:'UTIL'},
      {id:'b_util_5',cat:'util',title:'Speedtest',sub:'속도',href:'https://www.speedtest.net',badge:'UTIL'},
    ];

    // ---------------------------
    // DOM refs
    // ---------------------------
    const resetBtn = document.getElementById('resetBtn');
    const resetOrderBtn = document.getElementById('resetOrderBtn');
    const wipeBtn = document.getElementById('wipeBtn');
    const addBtn = document.getElementById('addBtn');
    const exportBtn = document.getElementById('exportBtn');
    const importBtn = document.getElementById('importBtn');
    const shareBtn = document.getElementById('shareBtn');
    const installBtn = document.getElementById('installBtn');
    const themeBtn = document.getElementById('themeBtn');

    const naverQ = document.getElementById('naverQ');
    const googleQ = document.getElementById('googleQ');
    const naverGo = document.getElementById('naverGo');
    const googleGo = document.getElementById('googleGo');

    const chips = Array.from(document.querySelectorAll('.chipbtn'));
    const grid = document.getElementById('grid');
    const favGrid = document.getElementById('favGrid');

    // Calendar
    const calFrame = document.getElementById('calFrame');
    const calSettingBtn = document.getElementById('calSettingBtn');

    // Todo
    const todoInput = document.getElementById('todoInput');
    const todoAddBtn = document.getElementById('todoAddBtn');
    const todoListEl = document.getElementById('todoList');
    const todoClearBtn = document.getElementById('todoClearBtn');

    // Modal refs
    const modalBack = document.getElementById('modalBack');
    const modalTitle = document.getElementById('modalTitle');
    const modalDesc = document.getElementById('modalDesc');
    const modalClose = document.getElementById('modalClose');

    const linkFormArea = document.getElementById('linkFormArea');
    const importArea = document.getElementById('importArea');
    const calArea = document.getElementById('calArea');

    // Link form
    const cancelBtn = document.getElementById('cancelBtn');
    const saveBtn = document.getElementById('saveBtn');
    const deleteBtn = document.getElementById('deleteBtn');
    const fCat = document.getElementById('fCat');
    const fBadge = document.getElementById('fBadge');
    const fTitle = document.getElementById('fTitle');
    const fSub = document.getElementById('fSub');
    const fHref = document.getElementById('fHref');

    // Import
    const importText = document.getElementById('importText');
    const importCancelBtn = document.getElementById('importCancelBtn');
    const applyImportBtn = document.getElementById('applyImportBtn');

    // Calendar modal
    const calEmbedUrl = document.getElementById('calEmbedUrl');
    const calId = document.getElementById('calId');
    const calResetBtn = document.getElementById('calResetBtn');
    const calCancelBtn = document.getElementById('calCancelBtn');
    const calSaveBtn = document.getElementById('calSaveBtn');

    // ---------------------------
    // State
    // ---------------------------
    let currentCat = 'all';
    let editingId = null;

    // ---------------------------
    // Theme
    // ---------------------------
    function applyTheme(theme){
      document.documentElement.setAttribute('data-theme', theme);
      saveJSON(THEME_KEY, theme);
      // theme-color meta sync (optional)
      const meta = document.querySelector('meta[name="theme-color"]');
      if(meta) meta.setAttribute('content', theme === 'dark' ? '#0b1220' : '#ffffff');
    }
    function toggleTheme(){
      const cur = loadJSON(THEME_KEY, 'light');
      applyTheme(cur === 'dark' ? 'light' : 'dark');
    }
    themeBtn.addEventListener('click', toggleTheme);

    // ---------------------------
    // Search
    // ---------------------------
    function openNaver(){
      const q = (naverQ.value || '').trim();
      if(!q) return;
      window.open(`https://search.naver.com/search.naver?query=${encodeURIComponent(q)}`, '_blank', 'noopener');
    }
    function openGoogle(){
      const q = (googleQ.value || '').trim();
      if(!q) return;
      window.open(`https://www.google.com/search?q=${encodeURIComponent(q)}`, '_blank', 'noopener');
    }
    naverGo.addEventListener('click', openNaver);
    googleGo.addEventListener('click', openGoogle);
    naverQ.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') openNaver(); });
    googleQ.addEventListener('keydown', (e)=>{ if(e.key === 'Enter') openGoogle(); });

    // ---------------------------
    // Favorites (GLOBAL)
    // ---------------------------
    function getFavList(){ return loadJSON(FAV_KEY, []); }
    function setFavList(list){ saveJSON(FAV_KEY, list); }
    function isFav(href){ return getFavList().some(x => x.href === href); }

    function toggleFav(item){
      const list = getFavList();
      const idx = list.findIndex(x => x.href === item.href);

      if(idx >= 0){
        list.splice(idx, 1);
        setFavList(list);
      }else{
        list.unshift(item);
        const seen = new Set();
        const deduped = [];
        for(const x of list){
          if(seen.has(x.href)) continue;
          seen.add(x.href);
          deduped.push(x);
        }
        const MAX_GLOBAL_FAV = 30;
        while(deduped.length > MAX_GLOBAL_FAV) deduped.pop();
        setFavList(deduped);
      }
      renderFav();
      syncStars();
    }

    function removeFav(href){
      const list = getFavList().filter(x => x.href !== href);
      setFavList(list);
      renderFav();
      syncStars();
    }

    function persistFavOrderFromDOM(){
      const hrefs = Array.from(favGrid.querySelectorAll('.favItem'))
        .map(el => el.dataset.href)
        .filter(Boolean);

      const list = getFavList();
      const map = new Map(list.map(x => [x.href, x]));
      const ordered = [];
      hrefs.forEach(h => { if(map.has(h)) ordered.push(map.get(h)); });
      list.forEach(x => { if(!hrefs.includes(x.href)) ordered.push(x); });
      setFavList(ordered);
    }

    function renderFav(){
      const list = getFavList();
      favGrid.innerHTML = '';

      if(list.length === 0){
        favGrid.innerHTML = `
          <div class="favItem" style="grid-column:1/-1; justify-content:flex-start;">
            <div class="favLeft">
              <div class="favLink">비어있음</div>
              <div class="favMeta">아래 카드의 ⭐를 눌러 즐겨찾기를 추가하세요.</div>
            </div>
          </div>
        `;
        return;
      }

      list.forEach(item => {
        const div = document.createElement('div');
        div.className = 'favItem';
        div.setAttribute('draggable','true');
        div.dataset.href = item.href;
        div.innerHTML = `
          <div class="favLeft">
            <a class="favLink" href="${item.href}" target="_blank" rel="noopener">${escapeHtml(item.title)}</a>
            <div class="favMeta">${escapeHtml(item.sub || '')}</div>
          </div>
          <button class="iconBtn danger" title="삭제">×</button>
        `;
        div.querySelector('.iconBtn').addEventListener('click', () => removeFav(item.href));
        favGrid.appendChild(div);
      });

      enableFavDrag();
    }

    function enableFavDrag(){
      const items = Array.from(favGrid.querySelectorAll('.favItem'));
      let draggingEl = null;

      items.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggingEl = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.href || '');
        });
        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          items.forEach(x => x.classList.remove('dragover'));
          draggingEl = null;
          persistFavOrderFromDOM();
        });
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          if(!draggingEl || draggingEl === el) return;
          el.classList.add('dragover');
        });
        el.addEventListener('dragleave', () => el.classList.remove('dragover'));
        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('dragover');
          if(!draggingEl || draggingEl === el) return;

          const rect = el.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);
          if(after) el.insertAdjacentElement('afterend', draggingEl);
          else el.insertAdjacentElement('beforebegin', draggingEl);
        });
      });
    }

    // ---------------------------
    // Custom links
    // ---------------------------
    function loadCustom(){ return loadJSON(CUSTOM_KEY, []); }
    function saveCustom(arr){ saveJSON(CUSTOM_KEY, arr); }
    function upsertCustom(item){
      const arr = loadCustom();
      const idx = arr.findIndex(x => x.id === item.id);
      if(idx >= 0) arr[idx] = item;
      else arr.unshift(item);
      saveCustom(arr);
    }
    function deleteCustom(id){
      saveCustom(loadCustom().filter(x => x.id !== id));
    }

    // ---------------------------
    // Order per category
    // ---------------------------
    function getOrderData(){ return loadJSON(ORDER_KEY, {}); }
    function setOrderData(data){ saveJSON(ORDER_KEY, data); }
    function getOrder(cat){
      const data = getOrderData();
      return Array.isArray(data[cat]) ? data[cat] : null;
    }
    function setOrder(cat, ids){
      const data = getOrderData();
      data[cat] = ids;
      setOrderData(data);
    }
    function clearOrder(cat){
      const data = getOrderData();
      delete data[cat];
      setOrderData(data);
    }

    // ---------------------------
    // Build items for category
    // ---------------------------
    function getItemsForCat(cat){
      const custom = loadCustom().map(x => ({...x, custom:true}));
      const all = BASE.map(x => ({...x, custom:false})).concat(custom);

      let items = (cat === 'all') ? all : all.filter(x => x.cat === cat);

      const order = getOrder(cat);
      if(order && order.length){
        const map = new Map(items.map(x => [x.id, x]));
        const ordered = [];
        order.forEach(id => { if(map.has(id)) ordered.push(map.get(id)); });
        items.forEach(x => { if(!order.includes(x.id)) ordered.push(x); });
        items = ordered;
      }
      return items;
    }

    // ---------------------------
    // Render grid
    // ---------------------------
    function renderGrid(){
      const items = getItemsForCat(currentCat);

      grid.innerHTML = items.map(item => {
        const menuHidden = item.custom ? '' : 'hidden';
        const draggable = (currentCat === 'all') ? 'false' : 'true';
        return `
          <a class="card" href="${item.href}" target="_blank" rel="noopener"
             data-id="${item.id}" data-cat="${item.cat}" draggable="${draggable}">
            <div class="left">
              <div class="title">${escapeHtml(item.title)}</div>
              <div class="metaRow">
                <div class="sub">${escapeHtml(item.sub || '')}</div>
                ${item.badge ? `<div class="badge" title="${escapeHtml(item.badge)}">${escapeHtml(item.badge)}</div>` : ``}
              </div>
            </div>
            <div class="star" title="즐겨찾기">☆</div>
            <div class="menu ${menuHidden}" title="내 링크 편집/삭제">⋯</div>
          </a>
        `;
      }).join('');

      attachCardHandlers();
      syncStars();
      updateCounts();
    }

    function attachCardHandlers(){
      const cards = Array.from(grid.querySelectorAll('.card'));
      cards.forEach(card => {
        const star = card.querySelector('.star');
        star.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          const item = {
            title: card.querySelector('.title')?.innerText || '즐겨찾기',
            sub: card.querySelector('.sub')?.innerText || '',
            href: card.getAttribute('href')
          };
          toggleFav(item);
        });

        const menu = card.querySelector('.menu');
        if(!menu.classList.contains('hidden')){
          menu.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            const id = card.dataset.id;
            const item = loadCustom().find(x => x.id === id);
            if(item) openLinkModal('edit', item);
          });
        }
      });

      if(currentCat !== 'all') enableCardDrag(cards);
    }

    function syncStars(){
      const anchors = Array.from(grid.querySelectorAll('.card'));
      anchors.forEach(card => {
        const star = card.querySelector('.star');
        const href = card.getAttribute('href');
        const on = isFav(href);
        star.classList.toggle('on', on);
        star.textContent = on ? '★' : '☆';
      });
    }

    function enableCardDrag(cards){
      let draggingEl = null;

      cards.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggingEl = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.id);
        });

        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          cards.forEach(x => x.classList.remove('dragover'));
          draggingEl = null;
          persistOrderFromDOM();
        });

        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          if(!draggingEl || draggingEl === el) return;
          el.classList.add('dragover');
        });

        el.addEventListener('dragleave', () => el.classList.remove('dragover'));

        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('dragover');
          if(!draggingEl || draggingEl === el) return;

          const rect = el.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);
          if(after) el.insertAdjacentElement('afterend', draggingEl);
          else el.insertAdjacentElement('beforebegin', draggingEl);
        });
      });
    }

    function persistOrderFromDOM(){
      if(currentCat === 'all') return;
      const ids = Array.from(grid.querySelectorAll('.card')).map(x => x.dataset.id);
      setOrder(currentCat, ids);
    }

    // ---------------------------
    // Counts
    // ---------------------------
    function updateCounts(){
      const cats = ['all','comm','prod','media','finance','ai','news','shop','community','dev','util'];
      const allItems = getItemsForCat('all');
      const counts = {};
      cats.forEach(c => counts[c] = 0);

      allItems.forEach(item => {
        counts['all'] += 1;
        if(counts[item.cat] !== undefined) counts[item.cat] += 1;
      });

      cats.forEach(c => {
        const el = document.querySelector(`[data-count="${c}"]`);
        if(el) el.textContent = `(${counts[c]})`;
      });
    }

    // ---------------------------
    // URL state
    // ---------------------------
    function updateUrlStateOnly(){
      const params = new URLSearchParams(location.search);
      if(currentCat === 'all') params.delete('cat');
      else params.set('cat', currentCat);
      const base = location.pathname + (params.toString() ? '?' + params.toString() : '');
      history.replaceState(null,'', base + (location.hash || ''));
    }

    // ---------------------------
    // Category switch
    // ---------------------------
    function setActiveChip(cat){
      chips.forEach(c => c.classList.toggle('active', c.dataset.cat === cat));
      currentCat = cat;
      updateUrlStateOnly();
      renderGrid();
    }
    chips.forEach(chip => chip.addEventListener('click', () => setActiveChip(chip.dataset.cat)));

    // ---------------------------
    // Buttons
    // ---------------------------
    function resetAll(){
      naverQ.value = '';
      googleQ.value = '';
      setActiveChip('all');
    }
    resetBtn.addEventListener('click', resetAll);

    resetOrderBtn.addEventListener('click', () => {
      if(currentCat === 'all') return;
      clearOrder(currentCat);
      renderGrid();
    });

    wipeBtn.addEventListener('click', () => {
      if(!confirm('개인화(즐겨찾기/정렬/내 링크/캘린더/투두)를 전부 초기화할까요?')) return;
      localStorage.removeItem(FAV_KEY);
      localStorage.removeItem(ORDER_KEY);
      localStorage.removeItem(CUSTOM_KEY);
      localStorage.removeItem(TODO_KEY);
      localStorage.removeItem(CAL_KEY);
      // theme는 유지(원하면 여기서도 지우면 됨)
      history.replaceState(null,'', location.pathname + location.search);
      renderFav();
      renderGrid();
      syncStars();
      renderTodo();
      loadCalendar();
    });

    addBtn.addEventListener('click', () => {
      const cat = (currentCat === 'all') ? 'comm' : currentCat;
      openLinkModal('add', {cat, badge:'ME', title:'', sub:'', href:''});
    });

    // ---------------------------
    // Export / Import / Share
    // ---------------------------
    function buildPersonalizationPayload(){
      return {
        v: 2,
        exportedAt: new Date().toISOString(),
        favorites: getFavList(),
        order: loadJSON(ORDER_KEY, {}),
        customLinks: loadCustom(),
        todo: loadJSON(TODO_KEY, []),
        calendar: loadJSON(CAL_KEY, null),
        theme: loadJSON(THEME_KEY, 'light'),
      };
    }

    function applyPersonalizationPayload(obj){
      // favorites
      const favorites = Array.isArray(obj.favorites) ? obj.favorites : [];
      // order
      const order = (obj.order && typeof obj.order === 'object') ? obj.order : {};
      // custom
      const customLinks = Array.isArray(obj.customLinks) ? obj.customLinks : [];
      // todo
      const todo = Array.isArray(obj.todo) ? obj.todo : [];
      // calendar
      const calendar = (obj.calendar && typeof obj.calendar === 'object') ? obj.calendar : null;
      // theme
      const theme = (obj.theme === 'dark' || obj.theme === 'light') ? obj.theme : 'light';

      const sanitizedCustom = customLinks
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          id: String(x.id || uid()),
          cat: String(x.cat || 'comm'),
          badge: String(x.badge || 'ME').slice(0,10),
          title: String(x.title || '').slice(0,60),
          sub: String(x.sub || '').slice(0,80),
          href: safeUrl(String(x.href || '')) || 'https://example.com'
        }));

      const sanitizedFav = favorites
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          title: String(x.title || '즐겨찾기').slice(0,60),
          sub: String(x.sub || '').slice(0,80),
          href: safeUrl(String(x.href || '')) || 'https://example.com'
        }));

      const sanitizedTodo = todo
        .filter(x => x && typeof x === 'object')
        .map(x => ({
          id: String(x.id || uid()),
          text: String(x.text || '').slice(0,120),
          done: !!x.done
        }))
        .filter(x => x.text.length > 0);

      saveJSON(FAV_KEY, sanitizedFav);
      saveJSON(ORDER_KEY, order);
      saveJSON(CUSTOM_KEY, sanitizedCustom);
      saveJSON(TODO_KEY, sanitizedTodo);
      if(calendar) saveJSON(CAL_KEY, calendar);
      applyTheme(theme);

      return true;
    }

    exportBtn.addEventListener('click', () => {
      const payload = buildPersonalizationPayload();
      const blob = new Blob([JSON.stringify(payload, null, 2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'dashboard-personalization.json';
      document.body.appendChild(a);
      a.click();
      a.remove();
      URL.revokeObjectURL(url);
    });

    importBtn.addEventListener('click', () => openImportModal());

    applyImportBtn.addEventListener('click', () => {
      const text = (importText.value || '').trim();
      if(!text){ alert('JSON을 붙여넣으세요.'); return; }
      if(!confirm('기존 개인화를 덮어쓰고 가져오겠습니까?')) return;

      let obj;
      try{ obj = JSON.parse(text); }
      catch{ alert('JSON 파싱 실패'); return; }

      applyPersonalizationPayload(obj);
      closeModal();
      renderFav(); renderGrid(); syncStars(); renderTodo(); loadCalendar();
    });

    importCancelBtn.addEventListener('click', closeModal);

    shareBtn.addEventListener('click', async () => {
      const payload = buildPersonalizationPayload();
      const json = JSON.stringify(payload);
      const packed = compressToEncodedURIComponent(json);

      const base = location.origin + location.pathname + location.search;
      const shareUrl = base + '#p=' + packed;

      try{
        await navigator.clipboard.writeText(shareUrl);
        alert('공유 링크(압축)가 클립보드에 복사되었습니다.');
      }catch{
        prompt('공유 링크를 복사하세요:', shareUrl);
      }
    });

    function tryApplyFromHash(){
      const hash = location.hash || '';
      if(!hash.startsWith('#p=')) return;

      const packed = hash.slice(3);
      if(!packed) return;

      const json = decompressFromEncodedURIComponent(packed);
      if (json == null) { alert('공유 링크 해석 실패(손상됨).'); return; }

      let obj;
      try{ obj = JSON.parse(json); }
      catch{ alert('공유 데이터 JSON 파싱 실패'); return; }

      const ok = confirm('공유 링크의 개인화를 이 브라우저에 적용할까요? (기존 개인화는 덮어쓰기)');
      if(!ok) return;

      applyPersonalizationPayload(obj);
      history.replaceState(null,'', location.pathname + location.search);
      renderFav(); renderGrid(); syncStars(); renderTodo(); loadCalendar();
      alert('적용 완료');
    }

    // ---------------------------
    // Modal open/close
    // ---------------------------
    function closeModal(){
      modalBack.style.display = 'none';
      editingId = null;

      // clear
      fTitle.value = '';
      fSub.value = '';
      fHref.value = '';
      fBadge.value = '';
      importText.value = '';
      calEmbedUrl.value = '';
      calId.value = '';
    }

    function openLinkModal(mode, item){
      modalBack.style.display = 'flex';
      linkFormArea.style.display = 'block';
      importArea.style.display = 'none';
      calArea.style.display = 'none';

      editingId = (mode === 'edit') ? item.id : null;

      if(mode === 'edit'){
        modalTitle.textContent = '내 링크 편집';
        modalDesc.textContent = '이 링크는 브라우저에만 저장됩니다.';
        deleteBtn.style.display = 'inline-flex';
      }else{
        modalTitle.textContent = '내 링크 추가';
        modalDesc.textContent = '선택한 카테고리에 저장됩니다.';
        deleteBtn.style.display = 'none';
      }

      fCat.value = item.cat || 'comm';
      fBadge.value = item.badge || 'ME';
      fTitle.value = item.title || '';
      fSub.value = item.sub || '';
      fHref.value = item.href || '';
    }

    function openImportModal(){
      modalBack.style.display = 'flex';
      linkFormArea.style.display = 'none';
      importArea.style.display = 'block';
      calArea.style.display = 'none';
      modalTitle.textContent = '개인화 가져오기';
      modalDesc.textContent = 'JSON을 붙여넣고 가져오기 적용을 누르세요.';
      importText.value = '';
    }

    function openCalendarModal(){
      modalBack.style.display = 'flex';
      linkFormArea.style.display = 'none';
      importArea.style.display = 'none';
      calArea.style.display = 'block';
      modalTitle.textContent = 'Google Calendar 연동 설정';
      modalDesc.textContent = '임베드 URL 또는 캘린더 ID를 저장합니다(로컬).';

      const saved = loadJSON(CAL_KEY, null);
      calEmbedUrl.value = saved?.embedUrl || '';
      calId.value = saved?.calId || '';
    }

    modalClose.addEventListener('click', closeModal);
    modalBack.addEventListener('click', (e) => { if(e.target === modalBack) closeModal(); });
    cancelBtn.addEventListener('click', closeModal);

    window.addEventListener('keydown', (e) => {
      if(e.key === 'Escape'){
        if(modalBack.style.display === 'flex') closeModal();
        else resetAll();
      }
    });

    // ---------------------------
    // Link form validate/save/delete
    // ---------------------------
    function validateForm(){
      const cat = fCat.value;
      const badge = (fBadge.value || '').trim().slice(0,10);
      const title = (fTitle.value || '').trim().slice(0,60);
      const sub = (fSub.value || '').trim().slice(0,80);
      const hrefRaw = (fHref.value || '').trim();

      if(!title) return {ok:false, msg:'이름을 입력하세요.'};
      const href = safeUrl(hrefRaw);
      if(!href) return {ok:false, msg:'URL은 http/https 형식만 허용됩니다.'};

      return {ok:true, data:{cat, badge, title, sub, href}};
    }

    saveBtn.addEventListener('click', () => {
      const v = validateForm();
      if(!v.ok){ alert(v.msg); return; }

      const item = v.data;
      if(editingId) upsertCustom({id:editingId, ...item});
      else upsertCustom({id:uid(), ...item});

      closeModal();
      renderGrid();
      updateCounts();
    });

    deleteBtn.addEventListener('click', () => {
      if(!editingId) return;
      if(!confirm('이 내 링크를 삭제할까요?')) return;
      deleteCustom(editingId);
      closeModal();
      renderGrid();
      updateCounts();
    });

    // ---------------------------
    // Calendar (embed only)
    // ---------------------------
    function buildCalendarEmbedFromId(id){
      // Agenda-style minimal
      const params = new URLSearchParams({
        mode: 'AGENDA',
        showTitle: '0',
        showNav: '0',
        showDate: '1',
        showPrint: '0',
        showTabs: '0',
        showCalendars: '0',
        showTz: '0',
        wkst: '1',
        bgcolor: '#ffffff',
        ctz: 'Asia/Seoul',
      });
      params.append('src', id);
      return 'https://calendar.google.com/calendar/embed?' + params.toString();
    }

    function loadCalendar(){
      const saved = loadJSON(CAL_KEY, null);

      // default: just open calendar.google.com (no embed)
      const fallback = 'https://calendar.google.com/calendar/u/0/r/agenda';
      if(!saved){
        // show a helpful “open” page in iframe if blocked, it still works in most cases
        calFrame.src = fallback;
        return;
      }

      let src = '';
      if(saved.embedUrl){
        const u = safeUrl(saved.embedUrl);
        if(u) src = u;
      }
      if(!src && saved.calId){
        src = buildCalendarEmbedFromId(String(saved.calId));
      }
      calFrame.src = src || fallback;
    }

    calSettingBtn.addEventListener('click', openCalendarModal);
    calCancelBtn.addEventListener('click', closeModal);

    calResetBtn.addEventListener('click', () => {
      if(!confirm('캘린더 연동을 초기화할까요?')) return;
      localStorage.removeItem(CAL_KEY);
      closeModal();
      loadCalendar();
    });

    calSaveBtn.addEventListener('click', () => {
      const embed = (calEmbedUrl.value || '').trim();
      const id = (calId.value || '').trim();

      const payload = {};
      if(embed){
        const u = safeUrl(embed);
        if(!u){ alert('임베드 URL이 올바르지 않습니다(http/https).'); return; }
        payload.embedUrl = u;
      }
      if(id) payload.calId = id;

      if(!payload.embedUrl && !payload.calId){
        alert('임베드 URL 또는 캘린더 ID 중 하나는 입력하세요.');
        return;
      }

      saveJSON(CAL_KEY, payload);
      closeModal();
      loadCalendar();
    });

    // ---------------------------
    // Todo (local)
    // ---------------------------
    function loadTodo(){ return loadJSON(TODO_KEY, []); }
    function saveTodo(list){ saveJSON(TODO_KEY, list); }

    function addTodo(text){
      const t = String(text || '').trim();
      if(!t) return;
      const list = loadTodo();
      list.unshift({id: uid(), text: t.slice(0,120), done:false});
      saveTodo(list);
      renderTodo();
    }

    function toggleTodo(id, done){
      const list = loadTodo();
      const idx = list.findIndex(x => x.id === id);
      if(idx < 0) return;
      list[idx].done = !!done;
      saveTodo(list);
      renderTodo();
    }

    function removeTodo(id){
      saveTodo(loadTodo().filter(x => x.id !== id));
      renderTodo();
    }

    function clearDone(){
      saveTodo(loadTodo().filter(x => !x.done));
      renderTodo();
    }

    function persistTodoOrderFromDOM(){
      const ids = Array.from(todoListEl.querySelectorAll('.todoItem'))
        .map(el => el.dataset.id)
        .filter(Boolean);
      const list = loadTodo();
      const map = new Map(list.map(x => [x.id, x]));
      const ordered = [];
      ids.forEach(id => { if(map.has(id)) ordered.push(map.get(id)); });
      list.forEach(x => { if(!ids.includes(x.id)) ordered.push(x); });
      saveTodo(ordered);
    }

    function renderTodo(){
      const list = loadTodo();
      todoListEl.innerHTML = '';

      if(list.length === 0){
        todoListEl.innerHTML = `
          <div class="todoItem" style="justify-content:flex-start;">
            <div class="todoLeft">
              <div class="todoText" style="color:var(--muted); font-weight:850;">비어있음</div>
            </div>
          </div>
        `;
        return;
      }

      list.forEach(item => {
        const el = document.createElement('div');
        el.className = 'todoItem';
        el.setAttribute('draggable','true');
        el.dataset.id = item.id;

        el.innerHTML = `
          <div class="todoLeft">
            <input class="todoCheck" type="checkbox" ${item.done ? 'checked' : ''} />
            <div class="todoText ${item.done ? 'done' : ''}">${escapeHtml(item.text)}</div>
          </div>
          <button class="iconBtn danger" title="삭제">×</button>
        `;

        el.querySelector('.todoCheck').addEventListener('change', (e) => {
          toggleTodo(item.id, e.target.checked);
        });
        el.querySelector('.iconBtn').addEventListener('click', () => removeTodo(item.id));

        todoListEl.appendChild(el);
      });

      enableTodoDrag();
    }

    function enableTodoDrag(){
      const items = Array.from(todoListEl.querySelectorAll('.todoItem'));
      let draggingEl = null;

      items.forEach(el => {
        el.addEventListener('dragstart', (e) => {
          draggingEl = el;
          el.classList.add('dragging');
          e.dataTransfer.effectAllowed = 'move';
          e.dataTransfer.setData('text/plain', el.dataset.id || '');
        });
        el.addEventListener('dragend', () => {
          el.classList.remove('dragging');
          items.forEach(x => x.classList.remove('dragover'));
          draggingEl = null;
          persistTodoOrderFromDOM();
        });
        el.addEventListener('dragover', (e) => {
          e.preventDefault();
          if(!draggingEl || draggingEl === el) return;
          el.classList.add('dragover');
        });
        el.addEventListener('dragleave', () => el.classList.remove('dragover'));
        el.addEventListener('drop', (e) => {
          e.preventDefault();
          el.classList.remove('dragover');
          if(!draggingEl || draggingEl === el) return;
          const rect = el.getBoundingClientRect();
          const after = (e.clientY - rect.top) > (rect.height / 2);
          if(after) el.insertAdjacentElement('afterend', draggingEl);
          else el.insertAdjacentElement('beforebegin', draggingEl);
        });
      });
    }

    todoAddBtn.addEventListener('click', () => {
      addTodo(todoInput.value);
      todoInput.value = '';
      todoInput.focus();
    });
    todoInput.addEventListener('keydown', (e) => {
      if(e.key === 'Enter'){
        addTodo(todoInput.value);
        todoInput.value = '';
      }
    });
    todoClearBtn.addEventListener('click', () => {
      if(!confirm('완료된 항목을 삭제할까요?')) return;
      clearDone();
    });

    // ---------------------------
    // Import/Export include todo/calendar/theme already
    // ---------------------------
    // (handled above)

    // ---------------------------
    // Share link apply
    // ---------------------------
    // (handled above)

    // ---------------------------
    // PWA install button
    // ---------------------------
    let deferredPrompt = null;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installBtn.style.display = 'inline-flex';
    });
    installBtn.addEventListener('click', async () => {
      if(!deferredPrompt) return;
      deferredPrompt.prompt();
      try{ await deferredPrompt.userChoice; } catch {}
      deferredPrompt = null;
      installBtn.style.display = 'none';
    });

    // ---------------------------
    // Service Worker register (optional)
    // ---------------------------
    async function registerSW(){
      if(!('serviceWorker' in navigator)) return;
      try{ await navigator.serviceWorker.register('./sw.js'); } catch {}
    }

    // ---------------------------
    // Init
    // ---------------------------
    function initChips(){
      const params = new URLSearchParams(location.search);
      const cat = params.get('cat') || 'all';
      const exists = chips.some(c => c.dataset.cat === cat);
      setActiveChip(exists ? cat : 'all');
    }

    function initTheme(){
      const theme = loadJSON(THEME_KEY, 'light');
      applyTheme(theme === 'dark' ? 'dark' : 'light');
    }

    function init(){
      initTheme();
      registerSW();
      initChips();
      renderFav();
      renderGrid();
      renderTodo();
      loadCalendar();
      tryApplyFromHash();
    }

    // Hook buttons that open modals
    importBtn.addEventListener('click', openImportModal);

    // Modal buttons already wired
    // Link modal open is in addBtn/menu handlers

    // Start
    init();
  </script>
</body>
</html>
